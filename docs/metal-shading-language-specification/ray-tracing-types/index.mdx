## 2.17 光线追踪类型

所有操作系统：自 Metal 2.3 起支持光线追踪类型。这些类型在命名空间 metal::raytracing 的头文件 中定义。在 Metal 2.3 中，这些类型仅在计算函数（内核函数）中受支持，除非下面另有说明。从 Metal 2.4 开始，顶点、片段和图块函数也支持它们。在 Metal 3.1 中，光线追踪支持曲线和多级实例。

## 2.17.1 光线追踪交叉点标签

所有操作系统：从 Metal 2. 3 开始支持光线追踪相交标签。

``2023 - 06 - 02 |版权所有 © 2023 苹果公司 |版权所有。 ````

Intersection_tags 在命名空间 metal::raytracing 的头文件 中定义。它们列于表 2. 9 中，并在定义时用于光线追踪

- 相交函数（[[intersection]] 第 5.1.6 节） - 相交函数表（intersection_function_table 第 2.17.3 节） - 相交结果（intersection_result 第 2.17.4 节） - 相交线类型和相关函数（相交线第 6.18.2 节） - 加速度结构类型（acceleration_struct 2.17.6 和 6.18.1 节） - 交集查询（intersection_query 6.18.4 节）。

标签用于配置光线追踪过程并控制不同类型和表的行为和语义。这些标签标识相交的加速器结构的类型、可用于相交函数的内置参数、相交函数表中相交函数的类型、相交类型或相交查询对象上可用的方法以及相交中返回的数据结果类型。

intersector_tags 的标签类型和顺序必须与 intersection_function_table、intersection_result、intersector 和 intersection_query 的相关使用之间匹配，否则编译器将生成错误。如果实例、primitive_motion 和 instance_motion 标签出现在用于与加速结构相交的其他光线跟踪类型上，则相交的加速结构类型必须与 instancing、primitive_motion 和 instance_motion 标签的顺序相匹配。在交集函数表中调用交集函数时，开发人员必须确保它们使用相同的有序标签集，否则结果是不确定的。

## 表 2.9。路口标签

`交叉点标签描述`

``` instancing 该标签表示交集函数可以读取内置的 instance_id 和/或 user_instance_id，如 5.2.3.7 节所述，并且加速结构是实例加速结构。 ````

``` intersector::intersect() 函数和 junction_query 假设加速结构需要是一个 instance_acceleration_struct，并且它返回 instance_id 值。 ````

``2023 - 06 - 02 |版权所有 © 2023 苹果公司 |版权所有。 ````

**交叉口标签说明**

triangle_data (^) 该标签指示三角形交集函数可以读取具有 barycentric_coord 或 front_faceing 属性的输入参数，如第 5.2.3.7 节所述。该标签不能用于定义加速结构。 intersector::intersect() 函数和 intersection_query 返回 triangle_barycentric_coord 和 triangle_front_faceing 值。 world_space_data 该标签指示使用该标签声明的交集函数可以查询 world_space_origin、world_space_direction、object_to_world_transform 和 world_to_object_transform，如第 5.2.3.7 节所述。该标签不能用于定义加速结构或 intersection_query。它支持 intersector 和 junction_function_table 中的世界空间数据。 Primitive_motion 所有操作系统：自 Metal 2. 4 起。此标签支持 intersector、intersection_query、intersection_function_table 和加速结构中的原始级别运动。 instance_motion 所有操作系统：自 Metal 2. 4 此标签支持 intersector、intersection_query、intersection_function_table 和加速结构中的实例级运动。 Extended_limits 所有操作系统：自 Metal 2. 4 此标签表示传递给交集函数的加速结构是使用基元数量、几何图形数量、实例数量的扩展限制构建的，并增加了用于可见性掩模的位数。该标签不能用于定义加速结构。 curve_data 从 Metal 3 开始。1 该标签使曲线交点的 curve_parameter 可以作为 Intersection_query 对象方法中 Intersection_result 对象的字段，并作为交集函数的输入参数，如第 5.2.3.7 节所述。

``2023 - 06 - 02 |版权所有 © 2023 苹果公司 |版权所有。 ````

`交叉点标签描述`

`max_levels 自 Metal 3.1`

``` 该标签支持 intersector、intersection_query 和 junction_function_table 中的多级实例化。它不能用于加速结构。 Count 是一个模板参数，决定了可以遍历的最大加速结构层数。对于交集查询，它必须在 [2, 16] 之间。对于交集来说它必须是[2,32]。对于 intersection_function_table，需要与 intersection_query 或 intersector 配合使用。 ````

在 Metal 2.3 中，以下是交叉标签的有效组合：

- 无标签 - triangle_data - 实例化 - 实例化、triangle_data - 实例化、world_space_data - 实例化、triangle_data、world_space_data

Metal 2.4 添加了以下附加有效组合：

-primitive_motion -triangle_data、primitive_motion -实例化、primitive_motion -实例化、triangle_data、primitive_motion -实例化、world_space_data、primitive_motion -实例化、triangle_data、world_space_data、primitive_motion -instance_motion -实例化、instance_motion -实例化、triangle_data、instance_motion -实例化、world_space_data、instance_motion -实例化、 三角形数据、 世界空间数据、 实例运动 - 实例化、 原始运动、 实例运动 - 实例化、 三角形数据、 原始运动、 实例运动 - 实例化、 世界空间数据、 原始运动、 实例运动 - 实例化、 三角形数据、 世界空间数据、 原始运动、 实例运动

``2023 - 06 - 02 |版权所有 © 2023 苹果公司 |版权所有。 ````

Extended_limits 标签可以添加到上面列出的所有组合中。

在 Metal 3.1 中，curve_data 可以添加到上面列出的所有组合中。交叉标签 max_levels 可以添加到上面包含实例的任何组合中。

## 2.17.2 射线类型

射线结构是相交所需射线属性的容器。

结构射线

{

射线（float3 原点= 0.0f，float3 方向= 0.0f，

浮动最小距离 = 0.0f，浮动最大距离 = INFINITY);

浮点 3 原点；

浮动 3 方向；

浮动最小距离；

浮动最大距离；

};

射线的原点和方向场位于世界空间中。当射线对象传递到自定义相交或三角形相交函数时， min_distance 和 max_distance 字段将基于当前搜索间隔：当发现候选相交时， max_distance 将减小以匹配新缩小的搜索间隔。在交集函数中，原点和方向将位于对象空间中。

射线可能是无效的。无效光线的示例包括：

- 原点或方向上的 INF 或 NaN - min_distance == NaN 或 max_distance == NaN - min_distance == INF（请注意，max_distance 可能为正 INF）。 - 长度(射线方向) == 0.0 - 最小距离 > 最大距离 - 最小距离 < 0.0 或 最大距离 < 0.0

射线方向不需要标准化，尽管它确实需要非零。

## 2.17.3 交集函数表

junction_function_table 结构类型描述了传递到着色器的自定义交集函数表，如第 5.1.6 节中所定义。交集标记根据表 2 进行定义。 9. junction_function_table 类型和交集函数上的交集标记必须匹配。这种声明的一个例子是

intersection_function_table junctionFuncs;

调用以下函数检查交集函数表是否为空。

``2023 - 06 - 02 |版权所有 © 2023 苹果公司 |版权所有。 ````

布尔值

is_null_intersection_function_table(

交集*函数*表<交集\_标签...>）

调用以下成员函数来检查 junction_function_table 是否为空。

bool 空() 常量

调用以下成员函数返回 intersection_function_table 中的条目数。

uint size() 常量

Metal 3 支持以下函数：get_buffer 和 get_visible_function_table。

调用以下成员函数以返回 junction_function_table 中索引处的缓冲区，其中 T 是设备或常量地址空间中的指针或引用。

template<类型名称 T> T get_buffer(uint index) const

调用以下成员函数以返回 intersection_function_table 索引处的 visible_function_table。 T 是存储在表中的函数的签名。

模板 <类型名称 T>visible_function_table get_visible_function_table(uint index) const;

Metal 3.1 支持以下函数：set_buffer 和 set_visible_function_table。

调用以下成员函数以在 junction_function_table 条目中的索引位置处设置设备或常量缓冲区对象。

void set_buffer（const device void *buf，uint 索引） void set_buffer（constant void *buf，uint 索引）

调用以下成员函数将 visible_function_table 设置在 intersection_function_table 中的索引位置，其中 T 是存储在表中的函数的签名。

template<typename T> void set_visible_function_table(visible_function_table<T> vft, uint index)

``2023 - 06 - 02 |版权所有 © 2023 苹果公司 |版权所有。 ````

## 2.17.4 交集结果类型

交集的结果在 junction_result 结构中返回，其中 junction_tags 在表 2 中定义。 9. 返回结构定义为

class intersection_type { none,triangle,bounding_box,curve // 从 Metal 3.1 开始可用 };

模板 struct junction_result { junction_type 类型；浮动距离； uint Primitive_id； uint 几何 ID；

const device void \*primitive_data; // 从 Metal 3 开始可用

// 仅当 Intersection_tags 包含不带 max_levels uint instance_id 的实例时才可用； uint user_instance_id； // 从 Metal 2.4 开始可用

// 从 Metal 3.1 开始，将 instance_id 和 user_instance_id 替换为

// 如果 intersection_tags 包含实例和 // max_levels，则为数组。 uint 实例计数； // 与射线相交的实例数。 uint instance_id[计数 - 1]； // 与射线相交的实例的实例 ID。 uint user_instance_id[计数 - 1]； // 与 // 相交的实例的用户实例 ID

// 射线。

// 仅当交集*标签包含三角形*数据时才可用。 float2 triangle*barycentric_coord;布尔三角形*正面\_面向；

// 从 Metal 2.4 开始，仅当 // junction_tags 包含 world_space_data 并实例化 float4x3 world_to_object_transform 时，以下内容才可用；

``2023 - 06 - 02 |版权所有 © 2023 苹果公司 |版权所有。 ````

float4x3 object_to_world_transform;

// 从 Metal 3.1 开始，只有当 // junction_tags 包含 curve_data 时，以下内容才可用。浮点曲线参数； };

如果光线无效，则返回 intersection::none。

返回的距离是在世界空间中。

对于顶点属性 v0、v1 和 v2，指定三角形重心点处的属性值为： v1 \_triangle_barycentric_coord.x + v2 \_triangle_barycentric_coord.y + v0 \* (1.0f - (triangle_barycentric_coord.x +triangle_barycentric_coord.y))

## 2.17.5 交叉线类型

intersector 结构类型定义了一个控制加速结构遍历的对象，并定义了像 intersect() 这样的与射线相交的函数。创建交集时，请使用 junction_tags（如表 2. 9 中所述）来专门说明其运行的加速结构类型以及可用的功能（请参阅第 6.18.2 节）。相交类型上的相交标记必须与其关联的相交函数相匹配（第 5.1.6 节），否则行为未定义。

// 创建一个默认的交集

intersector<>primitiveIntersector;

// 创建一个专门用于支持三角形和 // 世界空间数据的交集。 intersector instanceInter;

intersector 结构类型为 2.17.5 节中定义的交集结果类型提供了一种方便的类型：

相交::结果

## 2.17.6 加速结构类型

所有操作系统：从 Metal 2. 3 开始支持加速结构类型。

所有操作系统：自 Metal 2.4 起支持加速结构模板类型。

Metal 2.3 支持两种类型的加速结构：

``2023 - 06 - 02 |版权所有 © 2023 苹果公司 |版权所有。 ````

- 原始加速结构 - 实例加速结构。

这些是不透明对象，可以使用缓冲区绑定点或通过参数缓冲区直接绑定：

结构加速结构{

Primitive_acceleration_struct prim_accel；

instance_acceleration_struct inst_accel；

数组 prim_accel_array;

数组 inst_accel_array;

};

[[核心]]

空白

相交实例内核（

Primitive_acceleration_struct prim_accel [[buffer(0)]],

instance_acceleration_struct inst_accel [[buffer(1)]],

设备 AccelerationStructs \*accels [[buffer(3)]]) {...}

可以创建此类类型的默认初始化变量，并且默认值是加速结构的空值。

在 Metal 2.4 中，加速结构被模板化类型 Acceleration_struct 取代。模板参数 Intersection_tags 可以为空，也可以是 instancing、primitive_motion 或 instance_motion 的组合，如表 2 中所定义。 9. 交叉点标签。例如，下面定义了一个支持原始运动的实例加速结构。

Acceleration_struct<实例化，primitive_motion> Accel_struct；

以下标签组合可用于声明原始加速结构

- 无标签 - Primitive_motion

以下标签组合可用于声明实例加速结构

- 实例化 - 实例化、primitive_motion - 实例化、instance_motion - 实例化、primitive_motion、instance_motion

``2023 - 06 - 02 |版权所有 © 2023 苹果公司 |版权所有。 ````

为了保持向后兼容性，primitive_acceleration_struct 被别名为 acceleration_struct<>，instance_acceleration_struct 被别名为 acceleration_struct。

和以前一样，这些是不透明对象，可以使用缓冲区绑定点或通过参数缓冲区直接绑定：

结构 AccelerationMotionStructs {

Acceleration_struct prim_motion_accel;

Acceleration_struct<实例化，

实例运动> inst_motion_accel；

数组, 2> prim_accel_array;

array, 2> inst_accel_array;

};

[[核心]]

空白

相交运动内核（

Acceleration_struct prim [[buffer(15)]],

Acceleration_struct<实例化，

原始运动、实例运动>

安装[[缓冲区(16)]],

设备 AccelerationMotionStructs \*accels [[buffer(17)]]) {...}

将这些加速结构从 Metal API 绑定到计算或图形函数时，加速结构的类型必须与着色器中定义的类型相匹配。例如加速结构，可以将不支持 primitive_motion 的实例加速结构绑定到需要具有 primitive_motion 的实例加速结构的着色器。例如，具有实例加速结构的 Metal 缓冲区可以传递给具有 Acceleration_Structure 的着色器，也可以通过 Acceleration_Structure 传递给着色器。这一功能允许开发人员编写一个着色器函数，该函数可以处理带有或不带有 primitive_motion 的加速结构，但代价是光线追踪运行时检查基元运动。为了避免这种成本，开发人员可以编写两个函数，其中一个使用带 Primitive_motion 的加速结构，另一个不使用。

有关加速结构为空时要调用的函数，请参阅第 6.18.1 节。

``2023 - 06 - 02 |版权所有 © 2023 苹果公司 |版权所有。 ````

## 2.17.7 交集查询类型

所有操作系统：自 Metal 2. 4 起支持交叉口查询

Intersection_query 类型定义一个对象，使用户能够完全控制光线跟踪过程以及何时调用自定义相交代码。路口查询对象提供了一组函数，通过加速结构和查询遍历信息来推进查询。创建 Intersection_query 类型时，使用 junction_tags（在表 2. 9 中定义）来专门指定加速结构的类型以及可用的函数（请参阅第 6.18.4 节）。它支持以下交叉标签组合：

- 无标签 - triangle_data - 实例化 - 实例化，triangle_data

Metal 3.1 支持以下附加组合：

- 实例化，max_levels<计数> - 实例化，triangle_data，max_levels<计数>

在 Metal 3.1 中，curve_data 可以添加到上面列出的所有组合中。

Intersection_query 类型有以下限制

- 它不能用于结构/联合的成员 - 它不能从函数返回 - 它不能分配给

这些限制阻止复制交集查询对象。
