# 网格着色器类型

<OrigninalPDF title="2.19 Mesh Shader Types" />

所有操作系统：自 Metal 3 起就支持网格着色器类型。这些类型在网格管道中用于渲染几何体，并在标头 中定义。

## 网格属性类型

所有操作系统：从 Metal 3 开始就支持网格网格 PropertyType。

对象函数（请参阅第 5.1.7 节）可以使用 mesh_grid_properties 类型来指定要从对象阶段为给定线程组分派的网格网格的大小。

调用以下成员函数来控制将调度的网格线程组的数量。

无效 set_threadgroups_per_grid(uint3)

如果对象网格的给定线程组的成员函数 set_threadgroups_per_grid 从未被调用，则不会为给定对象网格线程组调度任何网格网格。对 set_threadgroups_per_grid 的调用表现为每个线程执行的对线程组内存的写入。

## 网格类型

所有操作系统：从 Metal 3 开始就支持网格类型。

网格函数（参见第 5.1.8 节）可以使用 mesh 结构类型的参数来表示导出的网格数据。表 2. 10 描述了网格模板参数。

## 表 2.10。网格模板参数

`模板参数`

` 描述`

``` V V 是顶点类型。````

`` P P 是原始类型。````

`` NV NV 是最大顶点数。````

`模板参数`

` 描述`

`` NP NP 是基元的最大数量。````

` t t 指定网格的拓扑。它是以下枚举值之一：枚举拓扑{点、线、三角形}`

有效的顶点类型 V 遵循与 5.2.3.3 节中定义的顶点函数返回类型相同的规则，但具有以下限制。顶点类型可以是

- float4 表示顶点位置或用户定义的结构：- 包含具有 [[position]] 属性的字段。- 可能包括整数或浮点类型的标量或向量的其它字段。- 支持表 2 中的以下属性。11. 每个属性可以在顶点类型中使用一次。

## 表 2.11。网格顶点属性

` 属性对应的数据类型`

` 描述`

`Clip_distance float 或 float[n] n 需要在编译时知道`

`从顶点到裁剪平面的距离`

`` 不变量 不适用；需要与 [[position]] ``` 一起使用

``` 标记输出位置，以便如果多个顶点着色器中用于计算输出位置的操作序列相同，则这些顶点着色器计算的结果输出位置很可能是相同的值。要求用户传递-fpreserve-invariance。请参阅下面的描述以了解更多信息。````

` 属性对应的数据类型`

` 描述`

`point_size float 点基元的大小`

`position float4 变换后的顶点位置`

``` 共享 不适用 如果存在，则对于每个 amplification_id，输出应具有相同的值。````

有效的基本类型遵循与片段输入部分 5.2.3.4 相同的规则。有效的原始类型是

- void 表示没有每个基元类型

或用户定义的结构

- 包括整数或浮点类型的标量或向量字段 - 仅支持表 2 中的以下属性。12. 每个属性可以在基元类型中使用一次。

`表 2.12. 网格体原始属性`

` 属性对应的数据类型`

` 描述`

``` Primitive_culled bool 如果设置为 true，则不渲染图元。````

``` Primitive_id uint 与重心坐标一起使用的每个基元标识符。````

`render_target_array_ind ex`

`uchar、ushort 或 uint`

``` 渲染目标数组索引，指立方体贴图的面、3D 纹理指定深度的数据、纹理数组的数组切片、数组切片或立方体贴图数组的面。对于立方体贴图，渲染目标数组索引是面索引，其值为 0 到 5 之间的值。对于立方体贴图数组，渲染目标数组索引计算如下：数组切片索引 \* 6 + 面索引。````

`viewport_array_index uchar、ushort 或 uint`

``` 图元的视口（和剪刀矩形）索引值。````

如果网格 未使用 [[primitive_culled]] 指定字段，则行为是渲染图元。如果片段着色器读取该字段，则读取的值为 false，因为该片段调用属于非剔除基元。

顶点和基元类型成员接受插值和采样限定符。该行为在第 5.2.3.4 节中指定。

为了最大限度地减少网格片段链接中可能出现的用户错误，用户定义的顶点和图元类型的字段名称在顶点和图元类型之间需要是唯一的。

网格 的示例是

struct VertexOut { float4 位置 [[位置]];

};

struct PrimitiveOut { 浮点颜色 [[平]]; };

使用 custom_mesh_t = metal::mesh;

网格类型包含以下静态数据成员。

## 表 2.13。网格静态成员

` 成员变量说明`

uint max_vertices (^) 网格中的最大顶点数 (NV)。uint max_primitive 网格中图元的最大数量 (NP)。uintindexs_per_primitive 基于拓扑 t 的每个基元的索引数。uint max_indices (^) 索引的最大数量 (max_primitive \*indexes_per_primitive)。调用以下成员函数将索引 I 处的顶点设置在 [0, max_vertices) 范围内。void set_vertex(uint I, V v) **如果 P 不为 void，则调用以下成员函数在 [0,** max_primitive **) 范围内设置索引 I 处的图元。**

无效 set_primitive(uint I, P p)

调用以下成员来设置基元计数，其中 c 在 [0, max_primitive] 范围内。

无效 set_primitive_count（uint c）

调用以下成员来设置 I 在 [0, max_indices) 范围内的索引。

无效 set_index(uint I, uchar v)

如果索引缓冲区中的位置有效并且索引缓冲区中的位置是 2（uchar2 重载）或 2（uchar 4 重载）的倍数，则调用以下 set_indices 函数来设置索引是合法的。索引 I 需要在 [0, max_indices) 范围内。

无效 set_indices（uint I，uchar2 v）无效 set_indices（uint I，uchar4 v）
