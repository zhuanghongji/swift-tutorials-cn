# 作为 ULP 的相对误差

<ToBePolishedAfterTranslation />

<OrigninalPDF title="7.4 Relative Error as ULPs" />

表 7.1 描述了以 ULP 值给出的单精度浮点基本算术运算和数学函数的最低精度。用于计算算术运算的 ULP 值的参考值是无限精确的结果。

<TableView
  num="7.1"
  title="Accuracy of single-precision floating-point operations and functions"
  headers={["Math Function", "Minimum Accuracy (ULP Values)"]}
  datasList={[
    ["x + y", "Correctly rounded"],
    ["x - y", "Correctly rounded"],
    ["x * y", "Correctly rounded"],
    ["1.0 / x", "Correctly rounded"],
    ["x / y", "Correctly rounded"],
    ["acos", "<= 4 ulp"],
    ["acosh", "<= 4 ulp"],
    ["asin", "<= 4 ulp"],
    ["asinh", "<= 4 ulp"],
    ["atan", "<= 5 ulp"],
    ["atan2", "<= 6 ulp"],
    ["atanh", "<= 5 ulp"],
    ["ceil", "Correctly rounded"],
    ["copysign", "0 ulp"],
    ["cos", "<= 4 ulp"],
    ["cosh", "<= 4 ulp"],
    ["cospi", "<= 4 ulp"],
    ["exp", "<= 4 ulp"],
    ["exp2", "<= 4 ulp"],
    ["exp10", "<= 4 ulp"],
    ["fabs", "0 ulp"],
    ["fdim", "Correctly rounded"],
    ["floor", "Correctly rounded"],
    ["fma", "Correctly rounded"],
    ["fmax", "0 ulp"],
    ["fmin", "0 ulp"],
    ["fmod", "0 ulp"],
    ["fract", "Correctly rounded"],
    ["frexp", "0 ulp"],
    ["ilogb", "0 ulp"],
    ["ldexp", "Correctly rounded"],
    ["log", "<= 4 ulp"],
    ["log2", "<= 4 ulp"],
    ["log10", "<= 4 ulp"],
    ["modf", "0 ulp"],
    ["nextafter", "0 ulp"],
    ["pow", "<= 16 ulp"],
    ["powr", "<= 16 ulp"],
    ["rint", "Correctly rounded"],
    ["round", "Correctly rounded"],
    ["rsqrt", "Correctly rounded"],
    ["sin", "<= 4 ulp"],
    ["sincos", "<= 4 ulp"],
    ["sinh", "<= 4 ulp"],
    ["sinpi", "<= 4 ulp"],
    ["sqrt", "Correctly rounded"],
    ["tan", "<= 6 ulp"],
    ["tanpi", "<= 6 ulp"],
    ["tanh", "<= 5 ulp"],
    ["trunc", "Correctly rounded"],
  ]}
/>

表 7.2 描述了单精度浮点算术运算的最低精度，以启用快速数学的 ULP 值给出（这是默认值，除非你指定 `-fno-fast-math` 作为编译器选项）。

<TableView
  num="7.2"
  title="Accuracy of single-precision operations and functions with fast math enabled"
  headers={["Math Function", "Minimum Accuracy (ULP Values)"]}
  datasList={[
    ["x + y", "Correctly rounded"],
    ["x - y", "Correctly rounded"],
    ["x * y", "Correctly rounded"],
    ["1.0 / x", "<= 1 ulp for x in the domain of 2e-126 to 2e126"],
    ["x / y", "<= 2.5 ulp for y in the domain of 2e-126 to 2e126"],
    ["acos(x)", "<= 5 ulp for x in the domain [-1, 1]"],
    ["acosh(x)", "Implemented as log(x + sqrt(x * x - 1.0))"],
    ["asin(x)", "<= 5 ulp for x in the domain [-1, 1] and |x| >= 2e-125"],
    ["asinh(x)", "Implemented as log(x + sqrt(x * x + 1.0))"],
    ["atan(x)", "<= 5 ulp"],
    ["atanh(x)", "Implemented as 0.5 * (log( (1.0 + x) / (1.0 - x) )"],
    ["atan2(y, x)", "Implemented as"],
    ["if x > 0, atan(y / x),", "if x < 0 and y > 0, atan(y / x) + M_PI_F"],
    [
      "if x < 0 and y < 0, atan(y / x) - M_PI_F",
      "and if x = 0 and y = 0, is undefined.",
    ],
    [
      "cos(x)",
      "For x in the domain [-pi, pi], the maximum absolute error is <= 2e-13 and larger otherwise.",
    ],
    ["cosh(x)", "Implemented as 0.5 * (exp(x) + exp(-x))"],
    [
      "cospi(x)",
      "For x in the domain [-1, 1], the maximum absolute error is <= 2e-13 and larger otherwise.",
    ],
    ["exp(x)", "<= 3 + floor(fabs(2 * x)) ulp"],
    ["exp2(x)", "<= 3 + floor(fabs(2 * x)) ulp"],
    ["exp10(x)", "Implemented as exp2(x * log2(10))"],
    ["fabs", "0 ulp"],
    ["fdim", "Correctly rounded"],
    ["floor", "Correctly rounded"],
    ["fma", "Correctly rounded"],
    ["fmax", "0 ulp"],
    ["fmin", "0 ulp"],
    ["fmod", "Undefined"],
    ["fract", "Correctly rounded"],
    ["frexp", "0 ulp"],
    ["ilogb", "0 ulp"],
    ["ldexp", "Correctly rounded"],
    [
      "log(x)",
      "For x in the domain [0.5, 2], the maximum absolute error is <= 2-21; otherwise if x > 0 the maximum error is <= 3 ulp; otherwise the results are undefined.",
    ],
    [
      "log2(x)",
      "For x in the domain [0.5, 2], the maximum absolute error is <= 2-22; otherwise if x > 0 the maximum error is <= 2 ulp; otherwise the results are undefined.",
    ],
    ["log10(x)", "Implemented as log2(x) * log10(2)"],
    ["modf", "0 ulp"],
    [
      "pow(x, y)",
      "Implemented as exp2(y * log2(x)). Undefined for x = 0 and y = 0.",
    ],
    [
      "powr(x, y)",
      "Implemented as exp2(y * log2(x)). Undefined for x = 0 and y = 0.",
    ],
    ["rint", "Correctly rounded"],
    ["round(x)", "Correctly rounded"],
    ["rsqrt", "<= 2 ulp"],
    [
      "sin(x)",
      "For x in the domain [-pi, pi], the maximum absolute error is <= 2-13 and larger otherwise.",
    ],
    ["sinh(x)", "Implemented as 0.5 * (exp(x) - exp(-x))"],
    ["sincos(x)", "ULP values as defined for sin(x) and cos(x)"],
    [
      "sinpi(x)",
      "For x in the domain [-1, 1], the maximum absolute error is <= 2-13 and larger otherwise.",
    ],
    [
      "sqrt(x)",
      "Implemented as x * rsqrt(x) with special cases handled correctly.",
    ],
    ["tan(x)", "Implemented as sin(x) * (1.0 / cos(x))"],
    ["tanh(x)", "Implemented as (t - 1.0)/(t + 1.0), where t = exp(2.0 * x)"],
    ["tanpi(x)", "Implemented as tan(x * pi)"],
    ["trunc", "Correctly rounded"],
  ]}
/>

<TableViewDataGenerator />

表 7.3 描述以 ULP 值给出的半精度浮点基本算术运算和数学函数的最低精度。表 7.3 适用于 iOS 和 macOS，从 `MTLGPUFamilyApple4` 硬件开始。

<TableView
  num="7.3"
  title="Accuracy of half-precision floating-point operations and functions"
  headers={["Math Function", "Minimum Accuracy (ULP Values)"]}
  datasList={[
    ["x + y", "Correctly rounded"],
    ["x - y", "Correctly rounded"],
    ["x * y", "Correctly rounded"],
    ["1.0 / x", "Correctly rounded"],
    ["x / y", "Correctly rounded"],
    ["acos(x)", "<= 1 ulp"],
    ["acosh(x)", "<= 1 ulp"],
    ["asin(x)", "<= 1 ulp"],
    ["asinh(x)", "<= 1 ulp"],
    ["atan(x)", "<= 1 ulp"],
    ["atanh(x)", "<= 1 ulp"],
    ["atan2(y, x)", "<= 1 ulp"],
    ["cos(x)", "<= 1 ulp"],
    ["cosh(x)", "<= 1 ulp"],
    ["cospi(x)", "<= 1 ulp"],
    ["exp(x)", "<= 1 ulp"],
    ["exp2(x)", "<= 1 ulp"],
    ["exp10(x)", "<= 1 ulp"],
    ["fabs", "0 ulp"],
    ["fdim", "Correctly rounded"],
    ["floor", "Correctly rounded"],
    ["fma", "Correctly rounded"],
    ["fmax", "0 ulp"],
    ["fmin", "0 ulp"],
    ["fmod", "0 ulp"],
    ["fract", "Correctly rounded"],
    ["frexp", "0 ulp"],
    ["ilogb", "0 ulp"],
    ["ldexp", "Correctly rounded"],
    ["log(x)", "<= 1 ulp"],
    ["log2(x)", "<= 1 ulp"],
    ["log10(x)", "<= 1 ulp"],
    ["modf", "0 ulp"],
    ["nextafter", "0 ulp"],
    ["rint", "Correctly rounded"],
    ["round(x)", "Correctly rounded"],
    ["rsqrt", "Correctly rounded"],
    ["sin(x)", "<= 1 ulp"],
    ["sinh(x)", "<= 1 ulp"],
    ["sincos(x)", "ULP values as defined for sin(x) and cos(x)"],
    ["sinpi(x)", "<= 1 ulp"],
    ["sqrt(x)", "Correctly rounded"],
    ["tan(x)", "<= 1 ulp"],
    ["tanh(x)", "<= 1 ulp"],
    ["tanpi(x)", "<= 1 ulp"],
    ["trunc", "Correctly rounded"],
  ]}
/>

表 7.4 描述了以 ULP 值给出的大脑浮点基本算术运算和数学函数的最低精度。表 7.4 适用于所有操作系统，从 `MTLGPUFamilyApple6` 或 `MTLGPUFamilyMac2` 硬件开始。

<TableView
  num="7.4"
  title="Accuracy of brain floating-point operations and functions"
  headers={["Math Function", "Minimum Accuracy (ULP Values)"]}
  datasList={[
    ["x + y", "Correctly rounded"],
    ["x - y", "Correctly rounded"],
    ["x * y", "Correctly rounded"],
    ["1.0 / x", "Correctly rounded"],
    ["x / y", "Correctly rounded"],
  ]}
/>

<TableView
  num="7.5"
  title="Accuracy of brain floating-point operations and functions with fast math enabled"
  headers={["Math Function", "Minimum Accuracy (ULP Values)"]}
  datasList={[
    ["x + y", "Correctly rounded"],
    ["x - y", "Correctly rounded"],
    ["x * y", "Correctly rounded"],
    ["1.0 / x", "<= 0.6 ulp for x in the domain of 2e-126 to 2e126"],
    ["x / y", "<= 0.6 ulp for y in the domain of 2e-126 to 2e126"],
  ]}
/>

尽管表 7.1 、表 7.2 、表 7.3 、表 7.4 和表 7.5 中指定了各个数学运算和函数的精度，但 Metal 编译器在快速数学模式下（请参阅 1.5.5)，可以进行各种优化，例如重新关联浮点运算，这可能会显着改变浮点结果。重新关联可能会更改或忽略零的符号，允许优化假设参数和结果不是 NaN 或 +/-INF，抑制或创建下溢或溢出，因此不能出现在依赖于舍入行为（例如代码中的 `(x + 2e52) - 2e52`），或有序浮点比较。

ULP 定义如下：

如果 `x` 是位于两个连续浮点数 a 和 b 之间的实数，且不等于其中之一，则 `ulp(x) = |b - a|`，否则 `ulp(x)` 是两者之间的距离最接近 `x` 的两个不相等的 finite 浮点数。此外，`ulp(NaN)` 是 `NaN`。
