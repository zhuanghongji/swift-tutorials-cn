<!doctype html>
<html lang="zh-hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-metal-programming-guide/convolutional-neural-networks/index">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">卷积神经网络 | Swift 悍刀行</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zhuanghongji.github.io/swift-tutorials-cn/docs/metal-programming-guide/convolutional-neural-networks"><meta data-rh="true" name="docusaurus_locale" content="zh-hans"><meta data-rh="true" name="docsearch:language" content="zh-hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="卷积神经网络 | Swift 悍刀行"><meta data-rh="true" name="description" content="&lt;Wisdom"><meta data-rh="true" property="og:description" content="&lt;Wisdom"><link data-rh="true" rel="icon" href="/swift-tutorials-cn/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zhuanghongji.github.io/swift-tutorials-cn/docs/metal-programming-guide/convolutional-neural-networks"><link data-rh="true" rel="alternate" href="https://zhuanghongji.github.io/swift-tutorials-cn/docs/metal-programming-guide/convolutional-neural-networks" hreflang="zh-hans"><link data-rh="true" rel="alternate" href="https://zhuanghongji.github.io/swift-tutorials-cn/docs/metal-programming-guide/convolutional-neural-networks" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/swift-tutorials-cn/blog/rss.xml" title="Swift 悍刀行 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/swift-tutorials-cn/blog/atom.xml" title="Swift 悍刀行 Atom Feed"><link rel="stylesheet" href="/swift-tutorials-cn/assets/css/styles.a7cf13f8.css">
<link rel="preload" href="/swift-tutorials-cn/assets/js/runtime~main.5bdca63d.js" as="script">
<link rel="preload" href="/swift-tutorials-cn/assets/js/main.0cbf57d5.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/swift-tutorials-cn/"><div class="navbar__logo"><img src="/swift-tutorials-cn/img/logo.svg" alt="Swift 悍刀行" class="themedImage_ToTc themedImage--light_HNdA"><img src="/swift-tutorials-cn/img/logo.svg" alt="Swift 悍刀行" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Swift 悍刀行</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/swift-tutorials-cn/docs/swift/welcome/about">Swift</a><a class="navbar__item navbar__link" href="/swift-tutorials-cn/docs/swiftui/essentials/about">SwiftUI</a><a class="navbar__item navbar__link" href="/swift-tutorials-cn/docs/swiftcharts/essentials/about">SwiftCharts</a><a class="navbar__item navbar__link" href="/swift-tutorials-cn/docs/swiftdata/essentials/about">SwiftData</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Frameworks</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/core-graphics/overview">Core Graphics</a></li><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/metal/overview">Metal</a></li><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/metalkit/overview">MetalKit</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Books</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/swift-tutorials-cn/docs/metal-programming-guide/introdution">Metal Programming Guide</a></li><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/metal-shading-language-specification/preface">Metal Shading Language Specification 3.1</a></li></ul></div><a href="https://github.com/zhuanghongji/swift-tutorials-cn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-github-link" aria-label="GitHub repository"></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">Metal 编程指南</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/introdution">引言</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/introdution">介绍</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/what-is-metal">Metal 基础</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/what-is-metal">什么是 Metal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/overview-of-rendering-and-raster-graphics">渲染和光栅图形概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/your-first-metal-application">你的第一个 Metal 应用</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/essential-mathematics-for-graphics">渲染与图形</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/essential-mathematics-for-graphics">图形基础数学</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/introduction-to-shaders">着色器简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/metal-resources-and-memory-management">Metal 资源和内存管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/libraries-functions-and-pipeline-states">库、函数和管道状态</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/2d-drawing">2D 绘图</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/introduction-to-3d-drawing">3D 绘图简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/advanced-3d-drawing">高级 3D 绘图</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/interfacing-with-model-io">与模型 I/O 接口</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/texturing-and-sampling">纹理和采样</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/multipass-rendering-techniques">多通道渲染技术</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/geometry-unleashed-tessellation-in-metal">释放几何： Metal 中的镶嵌</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/the-metal-compute-pipeline">数据并行编程</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/the-metal-compute-pipeline">Metal 计算管道</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/image-processing-in-metal">Metal 中的图像处理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/machine-vision">机器视觉</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/metal-performance-shaders-framework">Metal 性能着色器框架</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/neural-network-concepts">神经网络概念</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/convolutional-neural-networks">卷积神经网络</a></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/swift-tutorials-cn/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Metal 编程指南</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">数据并行编程</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">卷积神经网络</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>卷积神经网络</h1><div style="padding-left:1rem;padding-right:1rem;padding-top:0.5rem;padding-bottom:0.5rem;border-radius:0.5rem;background-color:#333333"><p>老虎要狩猎，鸟要飞；男人必须坐下来思考 &quot;为什么，为什么，为什么？&quot;</p>— Kurt Vonnegut</div><br><p>第 18 章“神经网络概念”在全连接神经网络的背景下对神经网络进行了高级概述。你可能已经注意到这种方法效率低下，并且可能认为也许有更好的方法。本章重点介绍一种创建神经网络的新方法：<em>卷积神经网络</em>。卷积神经网络是神经网络从低效的好奇心变成计算机科学研究前沿的原因。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="卷积神经网络的历史">卷积神经网络的历史<a href="#卷积神经网络的历史" class="hash-link" aria-label="卷积神经网络的历史的直接链接" title="卷积神经网络的历史的直接链接">​</a></h2><p>你的大脑处理信息的方式是一个迭代过程。当你看到一个物体时，你意识的顶层会吸收边缘和颜色等粗略特征。这种意识的下一个层次会细化这些细节，以检测鼻子和眼睛等个体特征。在最深的层面上，这些改进结合在一起，你的大脑就会识别出一个物体。这是卷积神经网络如何对图像进行分类的基础。</p><p>在全连接的神经网络中，在每一层神经元中，每个神经元都与其前面和后面的每个神经元完全连接。如果你有一个只有 100 个像素正方形的小图像，并且每个像素都是一个输入，那么你就有一个包含 1,000 个神经元的输入层，并且这千个神经元中的每一个都连接到第一个隐藏层中的每个神经元。</p><p>正如第 18 章所讨论的，周围的像素与选定的像素相加并进行处理，这导致大量像素被采样。当你移动到下一个像素时，你将对先前操作中已采样并求和的一定数量的像素进行重新采样。</p><p>最早的卷积神经网络于 1994 年实现。第一个神经网络 <em>LeNet5</em> 是由 Yann LeCun 创建的 LeNet5 的突破在于认识到可识别的图像特征存在并且可以在整个图像中检测到（见图 20.1）。然后可以提取这些特征并将其用作训练参数，并与其他图像中的类似特征进行比较。</p><div style="display:flex;flex-direction:column;width:100%;justify-content:center;align-items:center"><div style="width:420px;padding:1rem;background-color:white"><div style="background-size:cover;background-repeat:no-repeat;position:relative;background-image:url(&quot;data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAEAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAUI/8QAHxAAAgICAQUAAAAAAAAAAAAAAQIAAwQRBRITMUGR/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/EABURAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIRAxEAPwDTdWJXaH7rWOA5Gi3zxJGRyN1WRbWor6UYqNj0DERB/9k=&quot;);width:100%"><svg style="width:100%;height:auto;max-width:100%;margin-bottom:-4px" width="614" height="232"></svg><noscript><img style="width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0" src="/swift-tutorials-cn/assets/ideal-img/20_1.a56af31.614.jpg" srcset="/swift-tutorials-cn/assets/ideal-img/20_1.a56af31.614.jpg 614w" width="614" height="232"></noscript></div></div><p style="margin-top:0.5rem;font-size:1.0rem"><em>图 20.1 第一个卷积神经网络 LeNet5 的直观表示</em></p></div><p>1994 年，还没有 GPU 来训练神经网络，CPU 的速度也明显变慢 LeNet5 允许你保存参数和计算，而不是使用每个像素作为单独的输入 LeNet5 利用多层来过滤掉相关的潜在特征，而不是使用暴力方法来查找这些特征。</p><p>LeNet5 为神经网络做出了多项进步：</p><ul><li>使用三层序列进行卷积神经网络：卷积、池化和最后的全连接</li><li>使用卷积提取空间特征 - 使用图像图的空间平均值进行子采样</li><li>使用 sigmoid 神经元 - 使用多层神经网络作为最终分类器</li><li>层之间的稀疏连接矩阵，以避免不必要的大量计算成本</li></ul><p>对人工智能的兴趣和研究潮起潮落。由于缺乏计算能力，神经网络并不实用，所以直到 2010 年，人们才对神经网络产生了很大的兴趣，也没有取得很大的进展。就在那时，科学家们意识到 GPU 可以用来训练数据模型；这一认识激起了人们对神经网络的新兴趣。</p><p>Alex Krizhevsky 在 2012 年进一步激发了当前人们对卷积神经网络和使用 GPU 进行训练的兴趣。他在 ImageNet 竞赛中使用卷积神经网络参赛，并以比之前取得的任何成绩都令人难以置信的准确度飞跃获胜。最近对卷积神经网络的研究使得许多图像识别算法的准确性在短短 5 年内翻了一番。</p><p>AlexNet 将 LeNet5 的见解提升到了一个新的水平，如图 20.2 所示。这些贡献使得能够创建更大的网络来识别更复杂的对象。这些贡献包括：</p><ul><li>使用修正线性单元 (ReLU) 作为非线性</li><li>使用 dropout 技术在训练过程中有选择地忽略单个神经元，这是一种避免模型过度拟合。</li><li>重叠最大池化，避免平均池化的平均效应</li><li>使用 GPU NVidia GTX 580 来减少训练时间</li></ul><div style="display:flex;flex-direction:column;width:100%;justify-content:center;align-items:center"><div style="width:420px;padding:1rem;background-color:white"><div style="background-size:cover;background-repeat:no-repeat;position:relative;background-image:url(&quot;data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAACAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQI/8QAHBAAAgICAwAAAAAAAAAAAAAAAAECEQMxEiJR/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/EABQRAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhEDEQA/ANO5JNVTeyOcY8n1W/AAP//Z&quot;);width:100%"><svg style="width:100%;height:auto;max-width:100%;margin-bottom:-4px" width="655" height="118"></svg><noscript><img style="width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0" src="/swift-tutorials-cn/assets/ideal-img/20_2.5c4b35f.655.jpg" srcset="/swift-tutorials-cn/assets/ideal-img/20_2.5c4b35f.655.jpg 655w" width="655" height="118"></noscript></div></div><p style="margin-top:0.5rem;font-size:1.0rem"><em>图 20.2 使用 AlexNet，每一层都会细化图像，从基本组件（例如线条）到复杂图像（例如由基本组件组成的立方体）。</em></p></div><p>在完全连接的层中，输入和输出是一维数字向量。卷积层适用于 3D 数据。每个颜色通道的组件都位于自己的数据平面上。卷积核的工作方式与处理一维和二维数据的方式相似。它对输入周围的像素进行采样并对它们求和。卷积核不重叠，而不是每个像素都有一个输入。</p><p>如果你有一个 100 像素见方的图像，并且具有传统的完全连接层，那么你将拥有 1,000 个输入。使用卷积层，你将只有 34 个输入，因为你不会一遍又一遍地对相同的 9 个像素进行重新采样。本章的其余部分详细介绍了它在 Metal 中的工作原理以及如何使用 Metal Performance Shaders (MPS) 框架进行设置。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mpsimage">MPSImage<a href="#mpsimage" class="hash-link" aria-label="MPSImage的直接链接" title="MPSImage的直接链接">​</a></h2><p>使用卷积神经网络需要熟悉的第一个对象是 MPSImage。卷积神经网络使用图像来提取特征并进行监督学习。正如你之前所读到的，每个图像都分为多个通道。神经网络的纹理可以有多达 64 个通道 <code>MTLTexture</code> 对象未设置为发送超过四个通道，因此你需要一个特殊的纹理来包含网络的这些通道。</p><p>要创建 <code>MPSImage</code>，你需要一个 <code>MPSImageDescriptorMetal</code> 编程中的一个常见模式是使用描述符对象创建各种对象。创建 <code>MPSImage</code> 有两种不同的方法：一种用于单个图像，另一种用于包含多个图像。创建 <code>MPSImage</code> 需要以下属性：</p><ul><li><strong>通道格式</strong>：由 <code>MPSImageFeatureChannelFormat</code> 枚举表示。此属性对图像中单个通道的表示进行编码。编码可以是无符号整数或浮点数，具体取决于网络所需的精度。</li><li><strong>宽度</strong>：图像的宽度。</li><li><strong>高度</strong>：图像的高度。</li><li><strong>特征通道</strong>：每个像素的特征通道数。</li><li><strong>图像数量</strong>：批处理的图像数量。如果你只有一张图像，则不需要此属性。</li><li><strong>Usage</strong> ：由 <code>MTLTextureUsage</code> 结构表示。该属性包含描述如何使用纹理的选项。纹理只能按照其使用值指定的方式使用。这些使用值包括着色器读取、着色器写入和渲染目标。</li></ul><p><code>MPSImage</code> 的另一种风格是 <code>MPSTemporaryImage</code>。此类的存在是为了存储立即使用和丢弃的瞬态数据。临时镜像的存储模式是私有的。它用于提高性能并减少内存占用。它只是一个要使用和丢弃的图像缓存。</p><p><code>MPSImage</code> 和 <code>MPSTemporaryImage</code> 构成发送到神经网络的数据。实际处理是由 MPS 框架中可用的各个层完成的，本章其余部分将详细介绍。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="卷积神经网络内核">卷积神经网络内核<a href="#卷积神经网络内核" class="hash-link" aria-label="卷积神经网络内核的直接链接" title="卷积神经网络内核的直接链接">​</a></h2><p>所有神经网络层的基类是 <code>MPSCNNKernel</code>。该类的主要作用是使用 <code>MPSImage</code> 对象，对其进行处理，然后返回一个新对象。处理图像的区域以及处理方式由 <code>MPSCNNKernel</code> 类的属性指定。</p><p><code>MPSCNNKernel</code> 的一项重要属性是 <code>MPSOffset</code>。这是一组有符号的 <em>x</em> 、 <em>y</em> 和 <em>z</em> 坐标，指定处理将在距离左上角多远的地方进行 <code>MPSCNNKernel</code> 上还有一个名为 <code>ClipRect</code> 的可选属性，它指定将覆盖像素数据的 <code>MTLRegion</code>。如果未指定此属性，则覆盖整个区域。</p><p>你还需要指定 <code>MPSImageEdgeMode</code>。你想要指定过滤器在读取超出源图像范围时的行为。发生这种情况的原因可能是负 <code>offset</code> 属性，因为 offset + ClipRect.size 的值大于源图像，或者因为过滤器查看相邻像素，例如卷积过滤器。默认设置为 0。</p><p>你需要在 <code>MPSCNNKernel</code> 上设置的最后一个属性是 <code>destinationFeatureChannelOffset</code>。它表示在写入输出数据之前要跳过的目标图像中的通道数。例如，假设目标图像有 24 个通道，内核输出 8 个通道。如果你希望该目标图像的通道 8 到 15 用于输出，则可以将 <code>destinationFeatureChannelOffset</code> 属性的值设置为 8。</p><p>层类型有很多类别，但本章重点介绍三种最常见的类型：卷积、池化和全连接。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="卷积层">卷积层<a href="#卷积层" class="hash-link" aria-label="卷积层的直接链接" title="卷积层的直接链接">​</a></h3><p><em>卷积层</em>（图 20.3）是神经网络中的基础层和最重要的层。该层负责从你提供的输入中提取特征。要创建卷积层，你需要一个 MPSCNNConvolutionDescriptor：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// create convolution descriptor with appropriate stride</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> convDesc </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">MPSCNNConvolutionDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    kernelWidth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">kernelWidth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    kernelHeight</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">kernelHeight</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    inputFeatureChannels</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">inputFeatureChannels</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    outputFeatureChannels</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">outputFeatureChannels</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">convDesc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">strideInPixelsX </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">strideXY</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">convDesc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">strideInPixelsY </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">strideXY</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以下是创建 MPSCNNConvolutionDescriptor 所需属性的更详细概述：</p><ul><li><strong>kernelWidth</strong>：内核窗口的宽度</li><li><strong>kernelHeight</strong>：内核窗口的高度</li><li><strong>inputFeatureChannels</strong>：输入图像中每个像素的特征通道数</li><li><strong>outputFeatureChannels</strong>：输出图像中每个像素的特征通道数</li></ul><p>输入和输出特征通道的大小不需要相同。然而，内核的宽度和高度确实需要相同的大小，如图 20.3 所示。宽度和高度不需要是奇数。</p><div style="display:flex;flex-direction:column;width:100%;justify-content:center;align-items:center"><div style="width:420px;padding:1rem;background-color:white"><div style="background-size:cover;background-repeat:no-repeat;position:relative;background-image:url(&quot;data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAMAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAABAMI/8QAIBABAAEDBAMBAAAAAAAAAAAAAQMAAhEEEyIxBUFRYf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDSnlYpSG0snkQeVqnPPrqmx7+3ZjaDBjuo68JNTpobwbL1XP51TgwB8oP/2Q==&quot;);width:100%"><svg style="width:100%;height:auto;max-width:100%;margin-bottom:-4px" width="414" height="502"></svg><noscript><img style="width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0" src="/swift-tutorials-cn/assets/ideal-img/20_3.8c87268.414.jpg" srcset="/swift-tutorials-cn/assets/ideal-img/20_3.8c87268.414.jpg 414w" width="414" height="502"></noscript></div></div><p style="margin-top:0.5rem;font-size:1.0rem"><em>图 20.3 使用卷积层扫描输入图像</em></p></div><p>除了初始化器之外，你还必须设置卷积描述符的步幅。你需要</p><p>设置 X 和 Y 方向的步幅。这些指定每个维度的下采样因子。</p><p>接下来，你使用该卷积描述符来初始化 MPSCNNConvolution 内核：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">init</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">MTLDevice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   convolutionDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">MPSCNNConvolutionDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   kernelWeights</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">UnsafePointer</span><span class="token operator">&lt;</span><span class="token class-name">Float</span><span class="token operator">&gt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   biasTerms</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">UnsafePointer</span><span class="token operator">&lt;</span><span class="token class-name">Float</span><span class="token operator">&gt;?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   flags</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">MPSCNNConvolutionFlags</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>MPSCNNConvolution</code> 是 <code>MPSCNNKernel</code> 的子类。它将默认的 <code>MTLDevice</code> 以及你刚刚创建的 <code>MPSCNNConvolutionDescriptor</code> 作为参数。接下来，你输入从训练的数据模型中获得的内核权重和偏差 <code>MPSCNNConvolutionFlags</code> 是用于控制如何存储和使用内核权重的选项。目前，唯一的值是 <code>.none</code>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="池化层">池化层<a href="#池化层" class="hash-link" aria-label="池化层的直接链接" title="池化层的直接链接">​</a></h3><p><em>池化层</em> 的作用是减少网络中图像的空间大小。该层将信息压缩在图像的某个区域中，如图 20.4 所示。在连续的卷积层之间插入池化层是很常见的。</p><div style="display:flex;flex-direction:column;width:100%;justify-content:center;align-items:center"><div style="width:420px;padding:1rem;background-color:white"><div style="background-size:cover;background-repeat:no-repeat;position:relative;background-image:url(&quot;data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAFAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQI/8QAIBAAAQQCAQUAAAAAAAAAAAAAAQACBBEDBRIVMVFh0f/EABUBAQEAAAAAAAAAAAAAAAAAAAAC/8QAFxEBAQEBAAAAAAAAAAAAAAAAAQACEf/aAAwDAQACEQMRAD8A0JpYbup7BrpGU42ObQBN3ZJN329K06mZZrcSgPHFvxEU5yARe3//2Q==&quot;);width:100%"><svg style="width:100%;height:auto;max-width:100%;margin-bottom:-4px" width="396" height="212"></svg><noscript><img style="width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0" src="/swift-tutorials-cn/assets/ideal-img/20_4.625edb9.396.jpg" srcset="/swift-tutorials-cn/assets/ideal-img/20_4.625edb9.396.jpg 396w" width="396" height="212"></noscript></div></div><p style="margin-top:0.5rem;font-size:1.0rem"><em>图 20.4 池化层如何压缩其输入数据</em></p></div><p>池化层的基类是 <code>MPSCNNPooling</code>。这也是 <code>MPSCNNKernel</code> 以及用于构建神经网络的所有其他内核的子类。该基类有一个方法，<code>encode(commandBuffer:sourceImage:)</code>，用于将 <code>MPSCNNPooling</code> 对象编码为 <code>MTLCommandBuffer</code> 对象。</p><p>有两种常用的池化层类型：最大池化层和平均池化层 <code>MPSCNNPoolingMax</code> 滤波器返回图像中每个像素的滤波器区域中像素的最大值 <code>MPSCNNPoolingAverage</code> 过滤器返回过滤区域中像素的平均值。</p><p>池化层的实现看起来像这样：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">pool </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">MPSCNNPoolingMax</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        kernelWidth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        kernelHeight</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        strideInPixelsX</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        strideInPixelsY</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>内核宽度和高度的默认行为是将两者设置为 2 像素。你不必将其设置为 2，但如果你没有充分的理由使其不同，那么 2 是一个很好的默认值。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="全连接层">全连接层<a href="#全连接层" class="hash-link" aria-label="全连接层的直接链接" title="全连接层的直接链接">​</a></h3><p><em>全连接层</em> 通常是流程中的最后一层。想想招聘是如何进行的：你收到数十份简历，这些简历经过过滤并缩小到接受电话面试的十几个人。这些人被筛选成几个接受现场采访的人。然后最终决定哪人获得工作机会。前面的层正在对数据进行缩小和筛选，而全连接层的工作是根据所有这些处理做出最终决定。</p><p>之前，你了解了全连接层。全连接层的过滤器大小与输入大小相同。它们与卷积层类似，只不过你要过滤每个输入。神经网络通常具有多个卷积层和池化层，最终馈入一个全连接层，如图 20.5 所示。卷积层和池化层的目的是缩小输入，以便最终的全连接层可以将所有内容结合在一起。每个层都完全连接并不是最佳的，因为完全连接的层很昂贵。全连接层是你在神经网络上进行的所有处理的顶点。</p><div style="display:flex;flex-direction:column;width:100%;justify-content:center;align-items:center"><div style="width:420px;padding:1rem;background-color:white"><div style="background-size:cover;background-repeat:no-repeat;position:relative;background-image:url(&quot;data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAKAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAABAII/8QAHxAAAQQABwAAAAAAAAAAAAAAAQACAxEEEyIxMkGR/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQL/xAAXEQEBAQEAAAAAAAAAAAAAAAABAAIh/9oADAMBAAIRAxEAPwDSc0ksUrsmwDumBzqGoqcOA6aQOAIvtKDG1xHiCvTwv//Z&quot;);width:100%"><svg style="width:100%;height:auto;max-width:100%;margin-bottom:-4px" width="634" height="661"></svg><noscript><img style="width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0" src="/swift-tutorials-cn/assets/ideal-img/20_5.1f8171c.634.jpg" srcset="/swift-tutorials-cn/assets/ideal-img/20_5.1f8171c.634.jpg 634w" width="634" height="661"></noscript></div></div><p style="margin-top:0.5rem;font-size:1.0rem"><em>图 20.5 神经网络中的全连接层</em></p></div><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">init</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">MTLDevice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     convolutionDescriptor fullyConnectedDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">MPSCNNConvolutionDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     kernelWeights</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">UnsafePointer</span><span class="token operator">&lt;</span><span class="token class-name">Float</span><span class="token operator">&gt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     biasTerms</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">UnsafePointer</span><span class="token operator">&lt;</span><span class="token class-name">Float</span><span class="token operator">&gt;?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     flags</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">MPSCNNConvolutionFlags</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>MPSCNNFullyConnected</code> 层是一个卷积层，因此需要一个 <code>MPSCNNConvolutionDescriptor</code>。所有其他参数应该看起来很熟悉，因为它们与卷积层相同。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="卷积数据源">卷积数据源<a href="#卷积数据源" class="hash-link" aria-label="卷积数据源的直接链接" title="卷积数据源的直接链接">​</a></h2><p>全连接层还有另一个初始化程序，它具有替代的数据源：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">init</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">MTLDevice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> weights</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">MPSCNNConvolutionDataSource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>MPSCNNConvolutionDataSource</code> 协议是对卷积核的权重和偏差进行编码的另一种方法。该协议包括许多用于返回设置 <code>MPSCNNConvolution</code> 内核所需的对象的便利函数。这包括偏差项、数据类型和描述符。</p><p>以下是如何执行此操作的示例：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">DataSource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">NSObject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token class-name">MPSCNNConvolutionDataSource</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> kernelWidth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> kernelHeight</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> inputFeatureChannels</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> outputFeatureChannels</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> useLeaky</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">Data</span><span class="token operator">?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">load</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-&gt;</span><span class="token plain"> </span><span class="token class-name">Bool</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> url </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">Bundle</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">main</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">url</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">forResource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        withExtension</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">&quot;bin&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">do</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        data </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token class-name">Data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">contentsOf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> url</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">print</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">&quot;Error: could not load </span><span class="token string-literal interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">\(</span><span class="token string-literal interpolation">url</span><span class="token string-literal interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">: </span><span class="token string-literal interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">\(</span><span class="token string-literal interpolation">error</span><span class="token string-literal interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">purge</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    data </span><span class="token operator">=</span><span class="token plain"> </span><span class="token nil constant" style="color:rgb(189, 147, 249)">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">weights</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-&gt;</span><span class="token plain"> </span><span class="token class-name">UnsafeMutableRawPointer</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token class-name">UnsafeMutableRawPointer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">mutating</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">data</span><span class="token operator">!</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> </span><span class="token class-name">NSData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">bytes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">biasTerms</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">-&gt;</span><span class="token plain"> </span><span class="token class-name">UnsafeMutablePointer</span><span class="token operator">&lt;</span><span class="token class-name">Float</span><span class="token operator">&gt;?</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token nil constant" style="color:rgb(189, 147, 249)">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>该数据源符合 <code>MPSCNNConvolutionDataSource</code>，因此具有许多处理和加载数据所需的方法。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="神经网络图">神经网络图<a href="#神经网络图" class="hash-link" aria-label="神经网络图的直接链接" title="神经网络图的直接链接">​</a></h2><p>在 iOS 11 之前，你需要使用各种卷积神经网络对象创建大型、复杂的结构。这些在心理上可视化为图表，但 MPS 框架中不存在这种结构来简化神经网络的创建 iOS 11 的新增功能是引入了 <code>MPSNNGraph</code> 类。</p><p><code>MPSNNGraph</code> 是神经网络图像和过滤器节点图的优化表示。构成图的节点是</p><ul><li>MPSNNImageNode</li><li>MPSNNFilterNode</li><li>MPSNN 状态节点</li></ul><p>它们充当 <code>MPSNNGraph</code> 的基本节点 <code>MPSNNImageNode</code> 是用作图的基本节点的 <code>MPSImage</code> 的表示 <code>MPSNNFilterNode</code> 指示以下节点将创建过滤器阶段。最后，<code>MPSNNStateNode</code> 表示状态对象。</p><p>在 MPS 框架内，一组节点类代表每个图层类型中存在的类。例如，池化层中有一个名为 <code>MPSCNNPoolingMax</code> 的类，它创建池化层。有一个名为 <code>MPSCNNPoolingAverageNode</code> 的相关节点类。这些节点中的每一个都从其上方的层获取输入图像，并应用数据源的权重和偏差。这是一个例子：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> inputImage </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">MPSNNImageNode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">handle</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token nil constant" style="color:rgb(189, 147, 249)">nil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> conv1 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">MPSCNNConvolutionNode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">source</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> inputImage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    weights</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">DataSource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">&quot;conv1&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">16</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> pool1 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">MPSCNNPoolingMaxNode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">source</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> conv1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">resultImage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    filterSize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> conv2 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">MPSCNNConvolutionNode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">source</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> pool1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">resultImage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    weights</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">DataSource</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">&quot;conv2&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">16</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">32</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> pool2 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">MPSCNNPoolingMaxNode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">source</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> conv2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">resultImage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    filterSize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// ... and so on ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">guard</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> graph </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">MPSNNGraph</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                             resultImage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> conv9</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">resultImage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">fatalError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">&quot;Error: could not initialize graph&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>要开始 <code>MPSNNGraph</code>，你需要从一种基本节点类型开始。该节点充当第一个卷积节点的源节点。该节点的结果输入到池节点中。这一直持续到你声明了整个图表为止。最后一个节点用于初始化 <code>MPSNNGraph</code> 对象。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概括">概括<a href="#概括" class="hash-link" aria-label="概括的直接链接" title="概括的直接链接">​</a></h2><p>卷积神经网络已经存在了 20 多年，但直到 GPU 的发展之后，它们才真正变得实用。卷积神经网络可以由多种不同类型的层组成，但最常见的层集包括卷积、池化和全连接。这些网络可以使用 <code>MPSImage</code> 对象创建，也可以使用 <code>MPSNNGraph</code> 对象连接。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/zhuanghongji/swift-tutorials-cn/docs/metal-programming-guide/convolutional-neural-networks/index.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">最后<!-- -->于 <b><time datetime="2023-08-28T00:28:04.000Z">2023年8月28日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/swift-tutorials-cn/docs/metal-programming-guide/neural-network-concepts"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">神经网络概念</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#卷积神经网络的历史" class="table-of-contents__link toc-highlight">卷积神经网络的历史</a></li><li><a href="#mpsimage" class="table-of-contents__link toc-highlight">MPSImage</a></li><li><a href="#卷积神经网络内核" class="table-of-contents__link toc-highlight">卷积神经网络内核</a><ul><li><a href="#卷积层" class="table-of-contents__link toc-highlight">卷积层</a></li><li><a href="#池化层" class="table-of-contents__link toc-highlight">池化层</a></li><li><a href="#全连接层" class="table-of-contents__link toc-highlight">全连接层</a></li></ul></li><li><a href="#卷积数据源" class="table-of-contents__link toc-highlight">卷积数据源</a></li><li><a href="#神经网络图" class="table-of-contents__link toc-highlight">神经网络图</a></li><li><a href="#概括" class="table-of-contents__link toc-highlight">概括</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://developer.apple.com/xcode/swiftui/" target="_blank" rel="noopener noreferrer" class="footer__link-item">SwiftUI Overview</a></li><li class="footer__item"><a href="https://developer.apple.com/documentation/swiftui/" target="_blank" rel="noopener noreferrer" class="footer__link-item">SwiftUI Documentation</a></li><li class="footer__item"><a href="https://developer.apple.com/videos/swiftui-ui-frameworks" target="_blank" rel="noopener noreferrer" class="footer__link-item">SwiftUI &amp; UI Frameworks Videos</a></li><li class="footer__item"><a href="https://docs.swift.org/swift-book/documentation/the-swift-programming-language/" target="_blank" rel="noopener noreferrer" class="footer__link-item">The Swift Programming Language</a></li></ul></div><div class="col footer__col"><div class="footer__title">参考</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.fatbobman.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Fatbob Man</a></li><li class="footer__item"><a href="https://designcode.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Design Code</a></li><li class="footer__item"><a href="https://www.swiftanytime.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Swift Anytime</a></li><li class="footer__item"><a href="https://www.hackingwithswift.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Hacking With Swift</a></li></ul></div><div class="col footer__col"><div class="footer__title">探索</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.youtube.com/@Kavsoft" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kavsoft</a></li><li class="footer__item"><a href="https://www.youtube.com/@ChaoCode" target="_blank" rel="noopener noreferrer" class="footer__link-item">Chao Code</a></li><li class="footer__item"><a href="https://www.youtube.com/@iOSAcademy" target="_blank" rel="noopener noreferrer" class="footer__link-item">iOS Academy</a></li><li class="footer__item"><a href="https://www.youtube.com/@XCA" target="_blank" rel="noopener noreferrer" class="footer__link-item">Xcoding with Alfian</a></li></ul></div><div class="col footer__col"><div class="footer__title">发现</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/swift-tutorials-cn/sponsor-me">Sponsor Me</a></li><li class="footer__item"><a class="footer__link-item" href="/swift-tutorials-cn/sponsor-list">Sponsor List</a></li><li class="footer__item"><a href="https://twitter.com/ajizhhans" target="_blank" rel="noopener noreferrer" class="footer__link-item">Follow Twitter</a></li><li class="footer__item"><a href="https://github.com/zhuanghongji" target="_blank" rel="noopener noreferrer" class="footer__link-item">Follow GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 ZHUANGHONGJI<br><a style="font-size: 12px;color: white;" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International (CC BY 4.0) License</a></div></div></div></footer></div>
<script src="/swift-tutorials-cn/assets/js/runtime~main.5bdca63d.js"></script>
<script src="/swift-tutorials-cn/assets/js/main.0cbf57d5.js"></script>
</body>
</html>