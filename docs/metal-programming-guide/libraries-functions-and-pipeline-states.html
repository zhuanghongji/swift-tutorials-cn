<!doctype html>
<html lang="zh-hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-metal-programming-guide/libraries-functions-and-pipeline-states/index">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">库、函数和管道状态 | Swift 悍刀行</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zhuanghongji.github.io/swift-tutorials-cn/docs/metal-programming-guide/libraries-functions-and-pipeline-states"><meta data-rh="true" name="docusaurus_locale" content="zh-hans"><meta data-rh="true" name="docsearch:language" content="zh-hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="库、函数和管道状态 | Swift 悍刀行"><meta data-rh="true" name="description" content="&lt;Wisdom"><meta data-rh="true" property="og:description" content="&lt;Wisdom"><link data-rh="true" rel="icon" href="/swift-tutorials-cn/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zhuanghongji.github.io/swift-tutorials-cn/docs/metal-programming-guide/libraries-functions-and-pipeline-states"><link data-rh="true" rel="alternate" href="https://zhuanghongji.github.io/swift-tutorials-cn/docs/metal-programming-guide/libraries-functions-and-pipeline-states" hreflang="zh-hans"><link data-rh="true" rel="alternate" href="https://zhuanghongji.github.io/swift-tutorials-cn/docs/metal-programming-guide/libraries-functions-and-pipeline-states" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/swift-tutorials-cn/blog/rss.xml" title="Swift 悍刀行 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/swift-tutorials-cn/blog/atom.xml" title="Swift 悍刀行 Atom Feed"><link rel="stylesheet" href="/swift-tutorials-cn/assets/css/styles.a7cf13f8.css">
<link rel="preload" href="/swift-tutorials-cn/assets/js/runtime~main.b2921d86.js" as="script">
<link rel="preload" href="/swift-tutorials-cn/assets/js/main.d320bbb9.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/swift-tutorials-cn/"><div class="navbar__logo"><img src="/swift-tutorials-cn/img/logo.svg" alt="Swift 悍刀行" class="themedImage_ToTc themedImage--light_HNdA"><img src="/swift-tutorials-cn/img/logo.svg" alt="Swift 悍刀行" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Swift 悍刀行</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/swift-tutorials-cn/docs/swift/welcome/about">Swift</a><a class="navbar__item navbar__link" href="/swift-tutorials-cn/docs/swiftui/essentials/about">SwiftUI</a><a class="navbar__item navbar__link" href="/swift-tutorials-cn/docs/swiftcharts/essentials/about">SwiftCharts</a><a class="navbar__item navbar__link" href="/swift-tutorials-cn/docs/swiftdata/essentials/about">SwiftData</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Frameworks</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/core-graphics/overview">Core Graphics</a></li><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/metal/overview">Metal</a></li><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/metalkit/overview">MetalKit</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Books</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/swift-tutorials-cn/docs/metal-programming-guide/introdution">Metal Programming Guide</a></li><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/metal-shading-language-specification/preface">Metal Shading Language Specification 3.1</a></li></ul></div><a href="https://github.com/zhuanghongji/swift-tutorials-cn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-github-link" aria-label="GitHub repository"></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">Metal 编程指南</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/introdution">引言</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/introdution">介绍</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/what-is-metal">Metal 基础</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/what-is-metal">什么是 Metal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/overview-of-rendering-and-raster-graphics">渲染和光栅图形概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/your-first-metal-application">你的第一个 Metal 应用</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/essential-mathematics-for-graphics">渲染与图形</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/essential-mathematics-for-graphics">图形基础数学</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/introduction-to-shaders">着色器简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/metal-resources-and-memory-management">Metal 资源和内存管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/libraries-functions-and-pipeline-states">库、函数和管道状态</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/2d-drawing">2D 绘图</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/introduction-to-3d-drawing">3D 绘图简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/advanced-3d-drawing">高级 3D 绘图</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/interfacing-with-model-io">与模型 I/O 接口</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/texturing-and-sampling">纹理和采样</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/multipass-rendering-techniques">多通道渲染技术</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/geometry-unleashed-tessellation-in-metal">释放几何： Metal 中的镶嵌</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/the-metal-compute-pipeline">数据并行编程</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/the-metal-compute-pipeline">Metal 计算管道</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/image-processing-in-metal">Metal 中的图像处理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/machine-vision">机器视觉</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/metal-performance-shaders-framework">Metal 性能着色器框架</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/neural-network-concepts">神经网络概念</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/convolutional-neural-networks">卷积神经网络</a></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/swift-tutorials-cn/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Metal 编程指南</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">渲染与图形</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">库、函数和管道状态</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>库、函数和管道状态</h1><div style="padding-left:1rem;padding-right:1rem;padding-top:0.5rem;padding-bottom:0.5rem;border-radius:0.5rem;background-color:#333333"><p>一个原创的想法。这不会太难。图书馆里一定充满了它们。</p>— Stephen Fry</div><br><p>当你从简单的应用程序转向更复杂的应用程序时，你开始需要更多且不同的着色器。尽管你已经阅读并使用了着色器，但你尚未学会如何以逻辑方式组织大量着色器。本章概述 Metal 如何存储、编译和访问着色器。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="什么是库和函数">什么是库和函数？<a href="#什么是库和函数" class="hash-link" aria-label="什么是库和函数？的直接链接" title="什么是库和函数？的直接链接">​</a></h2><p>你可能会想，如果函数如此重要，为什么你还没有了解它们，但事实上，你一直在使用它们而没有意识到 <code>MTLFunction</code> 是你的着色器函数 <code>MTLFunction</code> 是用 Metal Shading Language (MTL) 编写并包含在 .metal 文件中的任何内容。函数分为三种类型：<em>vertex、fragment</em> 和 <em>kernel</em>。顶点和片段函数与 MTLRenderPipelineState 关联，内核函数与 MTLComputePipelineState 关联。</p><p>函数被收集到 <code>MTLLibrary</code> 对象中 <code>MTLLibrary</code> 协议定义了表示图形或计算函数库的对象的接口。库可以由编译的代码组成，也可以从从字符串读取的源代码中检索。本章介绍如何确定程序的最佳选项的实现细节。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="metal-两阶段编译架构">Metal 两阶段编译架构<a href="#metal-两阶段编译架构" class="hash-link" aria-label="Metal 两阶段编译架构的直接链接" title="Metal 两阶段编译架构的直接链接">​</a></h2><p>让我们回顾一下编译器理论 101。作为一名程序员，你知道你在 Xcode 中输入的字符和代码不会直接转换为计算机可以理解的格式。计算机讲机器代码，你可以学习直接编写机器代码，但这将是一个很大的痛苦。编程语言的开发是为了创建人类可读的方式与计算机交互。那么，如果计算机无法直接读取你编写的代码，它是如何工作的呢？</p><p>你知道，当你在 Xcode 中构建或运行程序时，你正在编译代码。这与 JavaScript 等在运行时解释代码的语言不同。当你触发代码构建时，Xcode 会触发 Metal 前端编译器，类似于 C、C++ 和 Objective-C 中使用的 Clang 编译器。该编译器将你的源代码转换为抽象语法树（AST）。编译器从这棵树中创建一个中间表示（IR）。这是两阶段编译过程的第一步，如图 7.1 所示。</p><div style="display:flex;flex-direction:column;width:100%;justify-content:center;align-items:center"><div style="width:720px;padding:1rem;background-color:white"><div style="background-size:cover;background-repeat:no-repeat;position:relative;background-image:url(&quot;data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAFAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQI/8QAIBAAAQQCAQUAAAAAAAAAAAAAAQACAwQRIRIVIjFB0f/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAVEQEBAAAAAAAAAAAAAAAAAAABAP/aAAwDAQACEQMRAD8A0jfp145qzI4mh55lkjiSYyB63rKs6bUOzFknz3H6iILEv//Z&quot;);width:100%"><svg style="width:100%;height:auto;max-width:100%;margin-bottom:-4px" width="639" height="283"></svg><noscript><img style="width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0" src="/swift-tutorials-cn/assets/ideal-img/7_1.31999b8.639.jpg" srcset="/swift-tutorials-cn/assets/ideal-img/7_1.31999b8.639.jpg 639w" width="639" height="283"></noscript></div></div><p style="margin-top:0.5rem;font-size:1.0rem"><em>图 7.1 两阶段编译架构</em></p></div><p>获得 IR 并不意味着你的代码已准备就绪。多个 GPU 支持 Metal，并且每个 GPU 都有自己独特的指令集。编译过程的第二阶段是获取此 IR 并将其转换为每个 GPU 的特定机器代码。第二阶段是在程序运行的特定设备上完成的。它采用 IR 并构建特定于 GPU 的后端命令。</p><p>这种两阶段编译结构可确保你的 Metal 库在每个受支持的 GPU 上正确编译，而不必使用无法在 GPU 上运行的编译代码来拖累应用程序包。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="在编译时和运行时创建库">在编译时和运行时创建库<a href="#在编译时和运行时创建库" class="hash-link" aria-label="在编译时和运行时创建库的直接链接" title="在编译时和运行时创建库的直接链接">​</a></h2><p>图形编程中计算成本最高的操作之一是构建着色器 Metal 提供的优化之一是能够在编译时而不是运行时构建着色器。这样做会将极其昂贵的操作（可能只需要执行一次）转移到不会影响用户的过程中。你甚至可以使用命令行工具在 Xcode 之外构建你的库。</p><p>在构建时，应用程序目标的编译源阶段中存在的任何 .metal 文件都将由 Metal 前端编译器进行编译，并且它们包含的任何函数都将构成默认库。该库可通过默认 MTLDevice 上的方法访问：newDefaultLibrary()。此方法的返回类型是可选的，因此如果在编译时没有构建默认库，它不会使应用程序崩溃。</p><p>还可以将 Metal 库二进制文件引入你的项目中。例如，如果你创建了一个开源图像处理框架，则可以将该 Metal 库导入其他人的项目中。库可以作为文件或数据导入。</p><p>在某些情况下，你需要创建一个函数而无法添加 .metal 文件。一个例子是，如果你正在为 Unity 之类的东西创建插件。在这种情况下，你可以从文本文件创建着色器，该文本文件将被编译并添加到默认库中 MTLDevice 上同步执行该操作的方法如下：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">makeLibrary</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">filepath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">throws</span><span class="token plain"> </span><span class="token operator">-&gt;</span><span class="token plain"> </span><span class="token class-name">MTLLibrary</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此代码的变体允许使用完成处理程序创建异步库：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">makeLibrary</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">source</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 options</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">MTLCompileOptions</span><span class="token operator">?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 completionHandler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token attribute atrule">@escaping</span><span class="token plain"> </span><span class="token class-name">MTLNewLibraryCompletionHandler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="从库加载函数">从库加载函数<a href="#从库加载函数" class="hash-link" aria-label="从库加载函数的直接链接" title="从库加载函数的直接链接">​</a></h3><p>成功创建一个库是一个很好的第一步，但如果你不能将这些功能集成到你的应用程序中，那么它不会给你带来任何好处。本节介绍如何将默认库中的函数加载到应用程序中 <code>MTLLibrary</code> 有一个名为 makeFunction 的方法：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">guard</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> fragmentProgram </span><span class="token operator">=</span><span class="token plain"> defaultLibrary</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">makeFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">&quot;lightingFragment&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">guard</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> vertexProgram </span><span class="token operator">=</span><span class="token plain"> defaultLibrary</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">makeFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(255, 121, 198)">&quot;lightingVertex&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此方法是从默认库中提取特定函数的最简单方法 makeFunction 方法采用一个表示默认库中函数名称的字符串。如果你使用渲染器，则需要提取顶点和片段函数。如果你做计算，你需要拉出一个核函数。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="命令编码器">命令编码器<a href="#命令编码器" class="hash-link" aria-label="命令编码器的直接链接" title="命令编码器的直接链接">​</a></h2><p>将库中的函数连接到处理管道对于图形处理的工作原理来说是直观的，但如果你对通用 GPU 编程感兴趣怎么办？如果你想建立一个神经网络并拥有一堆与之关联的 <code>MTLFunction</code> 对象，你会使用什么？</p><p>MTLDevice 有一个装载有命令编码器的命令队列。每个编码器执行特定类型的工作。你不会使用图形编码器进行通用 GPU 编程。到目前为止，你主要遇到了渲染命令编码器，但这只是几个命令编码器之一 Metal 支持以下编码器：</p><ul><li><strong>MTLRenderCommandEncoder</strong>：该编码器旨在生成单个渲染通道。它访问顶点着色器和片段着色器。</li><li><strong>MTLBlitCommandEncoder</strong>：该编码器已在第 6 章“ Metal 资源和内存管理”中讨论。它仅用于在缓冲区和纹理之间复制资源。该编码器的工作不需要使用你编写的任何 <code>MTLFunction</code>s。</li><li><strong>MTLComputeCommandEncoder</strong>：GPGPU 命令编码器专门访问内核函数。</li><li><strong>MTLParallelRenderCommandEncoder</strong>：该编码器采用一个或多个 MTLRenderCommandEncoder 对象。它允许你将每个渲染编码器分配给其自己的线程，以便可以并行执行渲染命令。该编码器不直接访问 MTLLibrary。相反，它是访问 <code>MTLLibrary</code> 的编码器的管理对象。</li></ul><p>在 Metal 中需要记住的最重要的事情之一是如何将数据设置为</p><p>处理。通过记住不同类型命令编码器的所有选项，你可以确保使用最适合你的工作的工具。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="渲染管线描述符和状态">渲染管线描述符和状态<a href="#渲染管线描述符和状态" class="hash-link" aria-label="渲染管线描述符和状态的直接链接" title="渲染管线描述符和状态的直接链接">​</a></h2><p>拥有 Metal 函数库固然很棒，但你需要一种方法将它们添加到渲染管道中。这是通过使用 MTLRenderPipelineDescriptor 对象来完成的 MTLRenderPipelineDescriptor 指定渲染通道期间使用的渲染配置状态，包括光栅化（例如多重采样）、可见性、混合、曲面细分和图形函数状态。以下是 MTLRenderPipelineDescriptor 的示例：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> pipelineStateDescriptor </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">MTLRenderPipelineDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pipelineStateDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">vertexFunction </span><span class="token operator">=</span><span class="token plain"> vertexProgram</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pipelineStateDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fragmentFunction </span><span class="token operator">=</span><span class="token plain"> fragmentProgram</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pipelineStateDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">vertexDescriptor </span><span class="token operator">=</span><span class="token plain"> vertexDescriptor</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>设置管道状态的第一件事是指定你正在使用默认库中的哪个顶点和片段程序。设置管道状态描述符后，需要使用它来初始化渲染管道状态。</p><p>渲染管道状态是使 Metal 比 OpenGL 高效得多的秘诀之一。你需要的大部分渲染状态都已烘焙到此管道描述符中。它不会强制渲染器在每次绘制调用时验证状态，而是已经知道该状态是有效的。</p><p>指定将进入管道状态的所有内容后，你需要将其添加到渲染管道中。此过程可能会失败，因此需要将其包含在 do-try-catch 块中。</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">do</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> pipelineState </span><span class="token operator">=</span><span class="token plain"> device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">makeRenderPipelineState</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">descriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> pipelineStateDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> error </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">print</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">&quot;Failed to create pipeline state, error </span><span class="token string-literal interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">\(</span><span class="token string-literal interpolation">error</span><span class="token string-literal interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="管道反射">管道反射<a href="#管道反射" class="hash-link" aria-label="管道反射的直接链接" title="管道反射的直接链接">​</a></h2><p>到目前为止，本章已经讨论了 <code>MTLFunction</code> 是一种访问在单独的 Metal 文件中编写的着色器的方法 <code>MTLFunction</code> 对象不提供对函数参数的访问。你可以在 <code>MTLFunction</code> 上访问的唯一属性是</p><ul><li>名称</li><li>函数类型</li><li>顶点属性</li></ul><p>该列表不包括着色器或计算函数参数的详细信息。这些参数必须使用 <code>MTLRenderPipelineReflection</code> 或 <code>MTLComputePipelineReflection</code> 获取 <code>MTLRenderPipelineReflection</code> <code>只有两个属性：vertexArguments</code> 和 <code>fragmentArguments</code>。两者都是 <code>MTLArgument</code> 对象的可选数组。如果你需要访问传递给顶点或片段着色器的任何参数，则必须通过管道反射访问它们，而不是直接从 <code>MTLFunction</code> 访问它们。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概括">概括<a href="#概括" class="hash-link" aria-label="概括的直接链接" title="概括的直接链接">​</a></h2><p>充分理解 Metal 如何构建和访问着色器库至关重要 Metal 认为着色器是函数对象 Metal 必须考虑到许多不同的 GPU 架构，同时还要确保你不会捆绑不需要的代码。了解决定实施着色器编译时的成本和收益也很重要。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/zhuanghongji/swift-tutorials-cn/docs/metal-programming-guide/libraries-functions-and-pipeline-states/index.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">最后<!-- -->于 <b><time datetime="2023-08-27T07:50:07.000Z">2023年8月27日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/swift-tutorials-cn/docs/metal-programming-guide/metal-resources-and-memory-management"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Metal 资源和内存管理</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/swift-tutorials-cn/docs/metal-programming-guide/2d-drawing"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">2D 绘图</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#什么是库和函数" class="table-of-contents__link toc-highlight">什么是库和函数？</a></li><li><a href="#metal-两阶段编译架构" class="table-of-contents__link toc-highlight">Metal 两阶段编译架构</a></li><li><a href="#在编译时和运行时创建库" class="table-of-contents__link toc-highlight">在编译时和运行时创建库</a><ul><li><a href="#从库加载函数" class="table-of-contents__link toc-highlight">从库加载函数</a></li></ul></li><li><a href="#命令编码器" class="table-of-contents__link toc-highlight">命令编码器</a></li><li><a href="#渲染管线描述符和状态" class="table-of-contents__link toc-highlight">渲染管线描述符和状态</a></li><li><a href="#管道反射" class="table-of-contents__link toc-highlight">管道反射</a></li><li><a href="#概括" class="table-of-contents__link toc-highlight">概括</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://developer.apple.com/xcode/swiftui/" target="_blank" rel="noopener noreferrer" class="footer__link-item">SwiftUI Overview</a></li><li class="footer__item"><a href="https://developer.apple.com/documentation/swiftui/" target="_blank" rel="noopener noreferrer" class="footer__link-item">SwiftUI Documentation</a></li><li class="footer__item"><a href="https://developer.apple.com/videos/swiftui-ui-frameworks" target="_blank" rel="noopener noreferrer" class="footer__link-item">SwiftUI &amp; UI Frameworks Videos</a></li><li class="footer__item"><a href="https://docs.swift.org/swift-book/documentation/the-swift-programming-language/" target="_blank" rel="noopener noreferrer" class="footer__link-item">The Swift Programming Language</a></li></ul></div><div class="col footer__col"><div class="footer__title">参考</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.fatbobman.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Fatbob Man</a></li><li class="footer__item"><a href="https://designcode.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Design Code</a></li><li class="footer__item"><a href="https://www.swiftanytime.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Swift Anytime</a></li><li class="footer__item"><a href="https://www.hackingwithswift.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Hacking With Swift</a></li></ul></div><div class="col footer__col"><div class="footer__title">探索</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.youtube.com/@Kavsoft" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kavsoft</a></li><li class="footer__item"><a href="https://www.youtube.com/@ChaoCode" target="_blank" rel="noopener noreferrer" class="footer__link-item">Chao Code</a></li><li class="footer__item"><a href="https://www.youtube.com/@iOSAcademy" target="_blank" rel="noopener noreferrer" class="footer__link-item">iOS Academy</a></li><li class="footer__item"><a href="https://www.youtube.com/@XCA" target="_blank" rel="noopener noreferrer" class="footer__link-item">Xcoding with Alfian</a></li></ul></div><div class="col footer__col"><div class="footer__title">发现</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/swift-tutorials-cn/sponsor-me">Sponsor Me</a></li><li class="footer__item"><a class="footer__link-item" href="/swift-tutorials-cn/sponsor-list">Sponsor List</a></li><li class="footer__item"><a href="https://twitter.com/ajizhhans" target="_blank" rel="noopener noreferrer" class="footer__link-item">Follow Twitter</a></li><li class="footer__item"><a href="https://github.com/zhuanghongji" target="_blank" rel="noopener noreferrer" class="footer__link-item">Follow GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 ZHUANGHONGJI<br><a style="font-size: 12px;color: white;" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International (CC BY 4.0) License</a></div></div></div></footer></div>
<script src="/swift-tutorials-cn/assets/js/runtime~main.b2921d86.js"></script>
<script src="/swift-tutorials-cn/assets/js/main.d320bbb9.js"></script>
</body>
</html>