<!doctype html>
<html lang="zh-hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-metal-programming-guide/the-metal-compute-pipeline/index" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">Metal 计算管道 | Swift 悍刀行</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zhuanghongji.github.io/swift-tutorials-cn/docs/metal-programming-guide/the-metal-compute-pipeline"><meta data-rh="true" property="og:locale" content="zh_hans"><meta data-rh="true" name="docusaurus_locale" content="zh-hans"><meta data-rh="true" name="docsearch:language" content="zh-hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Metal 计算管道 | Swift 悍刀行"><meta data-rh="true" name="description" content="&lt;Wisdom"><meta data-rh="true" property="og:description" content="&lt;Wisdom"><link data-rh="true" rel="icon" href="/swift-tutorials-cn/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zhuanghongji.github.io/swift-tutorials-cn/docs/metal-programming-guide/the-metal-compute-pipeline"><link data-rh="true" rel="alternate" href="https://zhuanghongji.github.io/swift-tutorials-cn/docs/metal-programming-guide/the-metal-compute-pipeline" hreflang="zh-hans"><link data-rh="true" rel="alternate" href="https://zhuanghongji.github.io/swift-tutorials-cn/docs/metal-programming-guide/the-metal-compute-pipeline" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/swift-tutorials-cn/blog/rss.xml" title="Swift 悍刀行 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/swift-tutorials-cn/blog/atom.xml" title="Swift 悍刀行 Atom Feed"><link rel="stylesheet" href="/swift-tutorials-cn/assets/css/styles.8473e0c6.css">
<script src="/swift-tutorials-cn/assets/js/runtime~main.f49cb785.js" defer="defer"></script>
<script src="/swift-tutorials-cn/assets/js/main.98f1431a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/swift-tutorials-cn/"><div class="navbar__logo"><img src="/swift-tutorials-cn/img/logo.svg" alt="Swift 悍刀行" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/swift-tutorials-cn/img/logo.svg" alt="Swift 悍刀行" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Swift 悍刀行</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/swift-tutorials-cn/docs/swift/welcome/about">Swift</a><a class="navbar__item navbar__link" href="/swift-tutorials-cn/docs/swiftui/essentials/about">SwiftUI</a><a class="navbar__item navbar__link" href="/swift-tutorials-cn/docs/swift-data/essentials/about">SwiftData</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Media</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/audio-toolbox/esseentials/about">Audio Toolbox</a></li><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/avf-audio/esseentials/about">AVFAudio</a></li><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/av-foundation/esseentials/about">AVFoundation</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Frameworks</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/core-graphics/overview">Core Graphics</a></li><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/charts/essentials/about">Charts</a></li><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/metal/overview">Metal</a></li><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/metalkit/overview">MetalKit</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Books</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/swift-tutorials-cn/docs/metal-programming-guide/introdution">Metal Programming Guide</a></li><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/metal-shading-language-specification/preface">Metal Shading Language Specification 3.1</a></li></ul></div><a href="https://github.com/zhuanghongji/swift-tutorials-cn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-github-link" aria-label="GitHub repository"></a><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">Metal 编程指南</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/introdution">引言</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/introdution">介绍</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/what-is-metal">Metal 基础</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/what-is-metal">什么是 Metal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/overview-of-rendering-and-raster-graphics">渲染和光栅图形概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/your-first-metal-application">你的第一个 Metal 应用</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/essential-mathematics-for-graphics">渲染与图形</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/essential-mathematics-for-graphics">图形基础数学</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/introduction-to-shaders">着色器简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/metal-resources-and-memory-management">Metal 资源和内存管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/libraries-functions-and-pipeline-states">库、函数和管道状态</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/2d-drawing">2D 绘图</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/introduction-to-3d-drawing">3D 绘图简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/advanced-3d-drawing">高级 3D 绘图</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/interfacing-with-model-io">与模型 I/O 接口</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/texturing-and-sampling">纹理和采样</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/multipass-rendering-techniques">多通道渲染技术</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/geometry-unleashed-tessellation-in-metal">释放几何： Metal 中的镶嵌</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/the-metal-compute-pipeline">数据并行编程</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/the-metal-compute-pipeline">Metal 计算管道</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/image-processing-in-metal">Metal 中的图像处理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/machine-vision">机器视觉</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/metal-performance-shaders-framework">Metal 性能着色器框架</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/neural-network-concepts">神经网络概念</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/convolutional-neural-networks">卷积神经网络</a></li></ul></li></ul></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/swift-tutorials-cn/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Metal 编程指南</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">数据并行编程</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Metal 计算管道</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>Metal 计算管道</h1>
<div><div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>警告</div><div class="admonitionContent_BuS1"><p>该文档目前仅完成 Google 翻译，需进一步校对和润色。</p></div></div></div>
<div style="padding-left:1rem;padding-right:1rem;padding-top:0.5rem;padding-bottom:0.5rem;border-radius:0.5rem;background-color:#333333"><p>相反，如果是这样的话，也可能是这样；如果是这样的话，那就是这样了；但既然不是，那就不是。这就是逻辑。</p>— Lewis Carroll</div><br>
<p>Metal 的一大承诺是它允许程序员进行通用 GPU 编程（GPGPU  编程）。多年来，随着 GPU 变得越来越强大，聪明的程序员已经意识到他们可以将大量不一定与图形相关的工作卸载到 GPU。本章重点介绍 Metal 中的 GPGPU 编程。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="metal-框架概念">Metal 框架概念<a href="#metal-框架概念" class="hash-link" aria-label="Metal 框架概念的直接链接" title="Metal 框架概念的直接链接">​</a></h3>
<p>尽管本章专门讨论 GPGPU 编程，但前面的许多章节介绍了你在阅读本章之前需要熟悉的概念。如果你的主要兴趣是 GPGPU 编程并且直接跳到本章，请在继续之前浏览这些章节：</p>
<ul>
<li>第 4 章，&quot;图形基础数学&quot;</li>
<li>第 5 章，&quot;着色器简介&quot;</li>
<li>第 6 章，&quot; Metal 资源和内存管理&quot;</li>
<li>第 7 章，&quot;库、函数和管道状态&quot;</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="gpu-编程简介">GPU 编程简介<a href="#gpu-编程简介" class="hash-link" aria-label="GPU 编程简介的直接链接" title="GPU 编程简介的直接链接">​</a></h2>
<p>在过去 10 年里，GPU 编程已成为吞吐量和速度的流行词 GPU 编程到底是什么？为什么它这么快？这个难题的第一部分是了解 GPU 与 CPU 的区别。</p>
<p><em>中央处理单元 (CPU)</em> 是计算机的大脑。它负责你计算机上的所有内容 CPU 的很大一部分必须专用于片上高速缓存。因此，CPU 只能将有限的空间分配给计算逻辑 GPU 具有更加专业化的灵活性 GPU 最大限度地利用了计算逻辑的可用空间。</p>
<p>GPU 通过算术逻辑单元 (ALU) 最大化其空间 ALU 是执行算术和按位运算的组合数字电子电路。在 CPU 上，这些运算主要是整数二进制数。在 GPU 上，这些运算主要是浮点数。我们人类对数学运算的看法与计算机不同。对我们来说，两个数字相乘是一次操作，但对计算机来说，它涉及位级别的多 个操作。通过拥有宽内存总线和许多 ALU，GPU 可以一次获取更多操作，如图 15.1 所示。通过扩展，GPU 在处理大量操作时比仅处理一两个操作更高效。</p>
<div style="display:flex;flex-direction:column;width:100%;justify-content:center;align-items:center"><div style="width:420px;padding:1rem;background-color:white"><div style="background-size:cover;background-repeat:no-repeat;position:relative;background-image:url(&quot;data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAHAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQI/8QAIRAAAQMDBAMAAAAAAAAAAAAAAgABAwUREwQSIVFUYZL/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oADAMBAAIRAxEAPwDRNNjlABEYzgJxfYMsmR2e7c369KrFWfJ0fw6IlR//2Q==&quot;);width:100%"><svg style="width:100%;height:auto;max-width:100%;margin-bottom:-4px" width="530" height="362"></svg><noscript><img style="width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0" src="/swift-tutorials-cn/assets/ideal-img/15_1.c674745.530.jpg" srcset="/swift-tutorials-cn/assets/ideal-img/15_1.c674745.530.jpg 530w" width="530" height="362"></noscript></div></div><p style="margin-top:0.5rem;font-size:1.0rem"><em>图 15.1 ALU 并行处理</em></p></div>
<p>CPU 每个芯片上的内核数量也有限。拥有多个内核使得芯片能够实现并行编程。每个内核一次只能完成一项任务，因此双核处理器在任何给定时间点执行的工作量是单核处理器的两倍。然而，多个核心会增加复杂性，因为核心必须协调它们处理任务的方式，而不覆盖两个核心正在访问的内存。</p>
<p>GPU 将这种并行处理提升到了一个新的水平 GPU 不限于两个、四个甚至十几个核心，而是拥有数千个核心。因此，GPU 可以同时执行数千个命令。这种设计实现了令人难以置信的快速 性能，但它也需要程序员进行大量的协调和组织。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="并发与并行">并发与并行<a href="#并发与并行" class="hash-link" aria-label="并发与并行的直接链接" title="并发与并行的直接链接">​</a></h2>
<p>关于并发和并行之间的区别存在一些混淆。它们有时可以互换使用，但它们是不同的概念。</p>
<p>如果你曾经暂停过 Xcode 模拟器中运行的程序并查看堆栈跟踪，则会发现在任何给定时间通常都有大约 16 个线程在运行。你没有创建这些线程——它们是由 Cocoa 框架在幕后实现的。这些线程并非同时进行处理。</p>
<p>假设你是一名独立游戏开发者。在任何一天，你都可以编写代码、设计艺术品和营销，但你无法同时完成所有这些事情。你正在同时执行这些操作。你就像一个运行三个线程工作的 CPU，但一次只能执行一个。</p>
<p>假设你雇用某人来创作你的艺术品。让别人免费创作艺术品</p>
<p>你可以去做其它工作了。如果你让艺术家与你并行工作，你可以优化这种安排，这样当你的其它工作完成并且你准备好你的艺术作品时，它已经在等着你了。</p>
<p>由于你一次只能执行一个线程，因此通过将工作委托给美工人员可以提高效率。现在想象一下，你有一个完整的艺术家工作室，他们可以同时处理游戏的不同部分 GPU 就像那个动画工作室。由于 GPU 有数千个核心，因此可以发送到 GPU 的工作越多，可以同时完成的工作就越多，如图 15.2 所示。</p>
<div style="display:flex;flex-direction:column;width:100%;justify-content:center;align-items:center"><div style="width:420px;padding:1rem;background-color:white"><div style="background-size:cover;background-repeat:no-repeat;position:relative;background-image:url(&quot;data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAMAAoDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAABQj/xAAhEAACAQMDBQAAAAAAAAAAAAABAgMAERIEIVETNHKhsf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCjtLiJpOm0RlsccWO3N96XiYmJCQWOI35odppElkBfNcGJDAW9Uxp+3i8R8oP/2Q==&quot;);width:100%"><svg style="width:100%;height:auto;max-width:100%;margin-bottom:-4px" width="636" height="760"></svg><noscript><img style="width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0" src="/swift-tutorials-cn/assets/ideal-img/15_2.651a3f4.636.jpg" srcset="/swift-tutorials-cn/assets/ideal-img/15_2.651a3f4.636.jpg 636w" width="636" height="760"></noscript></div></div><p style="margin-top:0.5rem;font-size:1.0rem"><em>图 15.2 并发与并行</em></p></div>
<p>你可能想知道如果在任何给定时刻只能执行一项任务，为什么还要有多个线程。不同的任务可以放在具有不同优先级的不同线程上。你很熟悉不要将所有工作都放在主线程上的警告。主线程的优先级是用户交互。在网络调用完成之前，你不想阻止用户交互。任何非用户界面函数调用都可以放在优先级较低的后台线程上。</p>
<p>Apple 的 Grand Central Dispatch (GCD) 框架监视所有线程并安排工作。它检查用户是否正在与应用程序交互。如果用户开始交互，</p>
<p>GCD 停止所有其它工作来处理主线程的要求。一旦工作完成，GCD 就可以回去安排其它任务在后台完成 A9 芯片功能如此强大，以至于所有这一切都可以无缝地进行，而用户无需意识到幕后发生的所有资源处理。</p>
<p>你可以使用许多编程模型来创建并行性。并行性可以构建到计算机体系结构、数据级别和指令级别 GPU 是建立在数据并行性之上的 CPU 并行性超出了本书的范围，但主要内容是 GPU 的并行性远远高于 CPU，并且向 GPU 发送工作可以给 你带来巨大的性能优势。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用-gpu-进行一般计算">使用 GPU 进行一般计算<a href="#使用-gpu-进行一般计算" class="hash-link" aria-label="使用 GPU 进行一般计算的直接链接" title="使用 GPU 进行一般计算的直接链接">​</a></h2>
<p>你可能会遇到的一个大问题是，GPU 可以执行哪些工作？你知道你无法将网络调用发送到 GPU 进行处理，因为 GPU 不执行该类工作。那么它可以做什么类型的工作呢？</p>
<p>GPU 旨在并行执行大量数学运算。例如，这需要将 1,000 个元素的数字数组中的每个元素乘以 2。它还需要将矩阵乘法和矩阵运算应用于大型数据集。许多科学和数学学科都是建立在线性代数概念的基础上的。这些包括但不限于以下内容：</p>
<ul>
<li>2D 和 3D 计算机图形学</li>
<li>图像处理</li>
<li>密码学</li>
<li>马尔可夫链</li>
<li>神经网络</li>
<li>经济学</li>
</ul>
<p>任何可以在矩阵中处理的数学运算都可以在 GPU 上并行执行。任何需要对每个成员执行一致操作的大型数据集都可以在 GPU 上执行 GPU 不能很好地处理条件逻辑，因此应不惜一切代价避免使用大量 if/else 语句的操作。</p>
<p>要了解哪些操作可以在 GPU 上轻松执行，请查看 Metal Shading Language 规范。至于你将其应用到什么学科，那取决于你。数学是许多科学学科的基础，因此不要将自己局限于互联网上的常见用例。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="内核函数">内核函数<a href="#内核函数" class="hash-link" aria-label="内核函数的直接链接" title="内核函数的直接链接">​</a></h2>
<p>在第 5 章&quot;着色器简介&quot;中，你熟悉了顶点和片段着色器。还有另一种类型的着色器函数：内核着色器，仅适用于 Metal 计算程序。与 3D 图形程序不同，使用计算程序时，你不必担心渲染问题 。你没有需要转换的顶点数据缓冲区</p>
<p>对象空间到世界空间，因此你不需要单独的顶点着色器将顶点数据提供给内核着色器。在许多方面，计算管道比图形渲染管道简单得多。</p>
<p>内核函数也是唯一为数据并行计算而设置的 <code>MTLFunction</code> 类型。正如&quot;并发与并行&quot;部分中所讨论的，GPU 拥有数千个核心。核函数可以在 1 维、2 维或 3 维网格上执行计算。</p>
<p>内核函数还必须具有 void 返回类型。顶点和片段函数存在于渲染管道上，这意味着每个函数的结果必须返回并传递到管道的下一部分。内核函数不返回输出。它们对值缓冲区应用数学运算，并且可以就地处理。</p>
<p>这是内核函数签名的典型示例：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kernel </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">kernel_function</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    texture2d</span><span class="token operator">&lt;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">float</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> access</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token plain">read</span><span class="token operator">&gt;</span><span class="token plain"> inTexture </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token function" style="color:rgb(80, 250, 123)">texture</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    texture2d</span><span class="token operator">&lt;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">float</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> access</span><span class="token double-colon punctuation" style="color:rgb(248, 248, 242)">::</span><span class="token plain">write</span><span class="token operator">&gt;</span><span class="token plain"> outTexture </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token function" style="color:rgb(80, 250, 123)">texture</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    uint2 gid </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">thread_position_in_grid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>该函数必须以名称 kernel 开头，以区别于顶点函数或片段函数。返回类型必须为 <code>void</code>。接下来是内核函数的名称。与处理其它类型的函数一样，你可以将参数表中的参数位置作为参数传递给内核函数。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="metal-计算命令编码器">Metal 计算命令编码器<a href="#metal-计算命令编码器" class="hash-link" aria-label="Metal 计算命令编码器的直接链接" title="Metal 计算命令编码器的直接链接">​</a></h2>
<p>发送到 GPU 的所有工作都被编码到 <code>MTLCommandEncoder</code> 实例中。有四种不同类型的命令编码器。到目前为止，在本书中，你已经学会了如何使用其中三个。本章介绍第四个也是最后一个：Metal 计算命令编码器（MTLComputeCommandEncoder）。</p>
<p>设置 <code>MTLComputeCommandEncoder</code> 比像任何其它对象一样简单地实例化它要复杂一些。它需要几个步骤并首先设置一些其它对象：</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">MTLDevice</span><span class="token operator">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> commandQueue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">MTLCommandQueue</span><span class="token operator">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> library</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">MTLLibrary</span><span class="token operator">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">setupMetal</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    device </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">MTLCreateSystemDefaultDevice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    commandQueue </span><span class="token operator">=</span><span class="token plain"> device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">makeCommandQueue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    library </span><span class="token operator">=</span><span class="token plain"> device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">newDefaultLibrary</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>设置 <code>MTLComputeCommandEncoder</code> 的方法 <code>makeComputeCommandEncoder()</code> 存在于 <code>MTLCommandBuffer</code> 对象上 <code>MTLCommandBuffer</code> 对象由 <code>MTLCommandQueue</code> 上的 <code>makeCommandBuffer()</code> 方法初始化 <code>MTLCommandQueue</code> 又由 <code>MTLDevice</code> 上的 <code>makeCommandQueue()</code> 方法创建。因此，要初始化 <code>MTLComputeCommandEncoder</code>，你需要设置一系列其它 Metal 对象，所有这些对象都会初始化链中的下一个。</p>
<p>将这三个对象全部初始化并就位后，你可以调用 <code>MTLCommandBuffer</code> 上的方法来初始化 <code>MTLComputeCommandEncoder</code>：</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> commandBuffer </span><span class="token operator">=</span><span class="token plain"> commandQueue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">makeCommandBuffer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> computeEncoder </span><span class="token operator">=</span><span class="token plain"> commandBuffer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">makeComputeCommandEncoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>乍一看这可能有点令人困惑，但无论如何，这些都是你需要创建的对象实例。尝试将其视为健全性检查，以确保你正确设置对象。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建计算管道状态">创建计算管道状态<a href="#创建计算管道状态" class="hash-link" aria-label="创建计算管道状态的直接链接" title="创建计算管道状态的直接链接">​</a></h3>
<p>正如你对渲染管道所做的那样，你可以在此处为计算管道创建管道状态。在对 GPU 进行编程时，尽可能多地预先设置是提高效率的最佳方法。第一步是创建计算管道状态变量：</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> computePipelineState</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">MTLComputePipelineState</span><span class="token operator">!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>创建该变量后，你需要对其进行设置：</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">setupPipeline</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> computeFunction </span><span class="token operator">=</span><span class="token plain"> library</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">makeFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> computeFunctionName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">do</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            computePipelineState </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">makeComputePipelineState</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">function</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> computeFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> error </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> </span><span class="token class-name">NSError</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token function" style="color:rgb(80, 250, 123)">fatalError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">&quot;Error: </span><span class="token string-literal interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">\(</span><span class="token string-literal interpolation">error</span><span class="token string-literal interpolation punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token string-literal interpolation">localizedDescription</span><span class="token string-literal interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">fatalError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">&quot;Kernel functions not found at runtime&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>设置状态所需的唯一部分是内核函数。你需要使用该函数来设置供管道状态使用的 Metal 库。如果由于某种原因你无法设置该库，你需要确保程序失败。最后，你需要将状态编码到计算管道中。</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">computeEncoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">setComputePipelineState</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">computePipelineState</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>到目前为止，一切都有些熟悉了。接下来，你将学习如何设置并行工作组，这是计算编码器独有的功能。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="发布工作网格">发布工作网格<a href="#发布工作网格" class="hash-link" aria-label="发布工作网格的直接链接" title="发布工作网格的直接链接">​</a></h2>
<p>本节介绍如何在 GPU 上设置并行处理。你可以控制一些移动部件，使你能够自定义工作的处理方式。你在这方面所做的选择会对你能够从 GPU 获得的性能产生重大影响。</p>
<p>在 GPU 上执行的任务有点类似于你必须完成的任何大型项目。该项目可以分解为离散的任务，由一组中的不同参与者完成。作为 GPU 项目经理，你的部分工作是确定完成这项工作所需的最佳人员数量以及如何在这些参与者之间分配这些任务。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="线程组">线程组<a href="#线程组" class="hash-link" aria-label="线程组的直接链接" title="线程组的直接链接">​</a></h3>
<p>执行工作的各个单元称为 <em>线程</em>。线程是以下集合之一</p>
<p>通过调度命令在设备上调用的内核函数的并行执行。线程通过其在网格中的线程位置和线程组中的线程位置来与集合中的其它执行区分开来。</p>
<p>GPU 对 GPU 上的每个线程进行微观管理的效率并不高。相反，它们被组装在 <em>线程组</em> 中。线程由一个或多个处理元素作为在计算单元上执行的线程组的一部分来执行，如图 15.3 所示。它们还共享一个指令指针，这意味着它们都同时执行相同的指令。线程组上可以执行的线程数就是 <em>线程执行宽度</em>。与计算机科学中的许多概念一样，最大执行宽度是 2 的幂。它根据你使用的 iPhone 版本而变化。功能更强大的 iPhone 具有更深的执行宽度。第 16 章&quot; Metal 图像处理&quot;中探讨了这个概念。</p>
<div style="display:flex;flex-direction:column;width:100%;justify-content:center;align-items:center"><div style="width:720px;padding:1rem;background-color:white"><div style="background-size:cover;background-repeat:no-repeat;position:relative;background-image:url(&quot;data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAEAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAUI/8QAHhABAQABAwUAAAAAAAAAAAAAAQIAAwQFETFBk9H/xAAVAQEBAAAAAAAAAAAAAAAAAAABA//EABcRAAMBAAAAAAAAAAAAAAAAAAABIQL/2gAMAwEAAhEDEQA/ANCcDDrclyunV1JNgMBKee4dctOxhVdfde6vuMYk8VU//9k=&quot;);width:100%"><svg style="width:100%;height:auto;max-width:100%;margin-bottom:-4px" width="695" height="262"></svg><noscript><img style="width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0" src="/swift-tutorials-cn/assets/ideal-img/15_3.4ccd2c4.695.jpg" srcset="/swift-tutorials-cn/assets/ideal-img/15_3.4ccd2c4.695.jpg 695w" width="695" height="262"></noscript></div></div><p style="margin-top:0.5rem;font-size:1.0rem"><em>图 15.3 在管道中执行的线程</em></p></div>
<p>首先，你需要线程组大小和线程组宽度的属性：</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> threadgroupSize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> threadsPerThreadgroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">MTLSize</span><span class="token operator">!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接下来，你需要计算线程组大小和线程组宽度有多大：</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">setupThreads</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> threadgroupWidth </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> μ </span><span class="token operator">=</span><span class="token plain"> side </span><span class="token operator">/</span><span class="token plain"> threadgroupWidth </span><span class="token operator">+</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">side </span><span class="token operator">==</span><span class="token plain"> threadgroupWidth </span><span class="token operator">?</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    threadgroupSize </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">MTLSize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">width</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> μ</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> height</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> μ</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> depth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    threadsPerThreadgroup </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">MTLSize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">width</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> threadgroupWidth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                                    height</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> threadgroupWidth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                                    depth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后，你需要将它们编码到计算命令编码器中：</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">computeEncoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">dispatchThreadgroups</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">threadgroupSize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                                    threadsPerThreadgroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                                    threadsPerThreadgroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这就是 CPU 方面所需的全部设置。其余的在 GPU 端设置。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="在内核函数内的网格中寻找方向">在内核函数内的网格中寻找方向<a href="#在内核函数内的网格中寻找方向" class="hash-link" aria-label="在内核函数内的网格中寻找方向的直接链接" title="在内核函数内的网格中寻找方向的直接链接">​</a></h2>
<p>在主代码中，设置每个线程组的线程数以及线程数</p>
<p>每个网格的线程组。当你对工作网格进行编码时，这些会被传递。你还需要传入网格中当前线程的位置：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">void</span><span class="token plain"> kernel </span><span class="token function" style="color:rgb(80, 250, 123)">myKernel</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     uint2 S </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> threads_per_threadgroup </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     uint2 W </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> threadgroups_per_grid </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     uint2 z </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> thread_position_in_grid </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这类似于片段着色器中跟踪当前正在处理的像素的参数。你不负责计算当前线程在网格或其各自线程组中的位置，但你可以通过向内核函数添加具有适当属性的参数来请求这些值。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="在内核函数中读写资源">在内核函数中读写资源<a href="#在内核函数中读写资源" class="hash-link" aria-label="在内核函数中读写资源的直接链接" title="在内核函数中读写资源的直接链接">​</a></h2>
<p>与使用渲染命令函数一样，你需要协调 CPU 和 GPU 之间的资源。如果你还记得前面的章节，Metal 使用参数表（如图 15.4 所示）来保存 CPU 和 GPU 之间共享的资源。在渲染编码器中，可以对三种类型的数据进行编码。对于计算编码器，还有一个附加参数类别。</p>
<div style="display:flex;flex-direction:column;width:100%;justify-content:center;align-items:center"><div style="width:420px;padding:1rem;background-color:white"><div style="background-size:cover;background-repeat:no-repeat;position:relative;background-image:url(&quot;data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAGAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAII/8QAHhAAAgEDBQAAAAAAAAAAAAAAAQIAAwQhEhMjkaH/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/8QAFBEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8A0tVt3RFpBhjOCQPJa7mkcjdmIgf/2Q==&quot;);width:100%"><svg style="width:100%;height:auto;max-width:100%;margin-bottom:-4px" width="557" height="309"></svg><noscript><img style="width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0" src="/swift-tutorials-cn/assets/ideal-img/15_4.ac727fb.557.jpg" srcset="/swift-tutorials-cn/assets/ideal-img/15_4.ac727fb.557.jpg 557w" width="557" height="309"></noscript></div></div><p style="margin-top:0.5rem;font-size:1.0rem"><em>图 15.4 计算编码器参数表</em></p></div>
<p>计算管道中 CPU 和 GPU 之间可以共享四种数据：</p>
<ul>
<li>缓冲区</li>
<li>纹理</li>
<li>采样器</li>
<li>线程组内存</li>
</ul>
<p><em>线程组内存</em> 是一个新类别。你可以在其中拥有的最大条目数</p>
<p>参数表的线程组内存部分为 31。在这些线程组中，iOS 上每个线程组最多有 512 个线程。在 macOS 上这扩展到 1024 个线程。参数表的最大总线程组内存分配为 16,352 字节。在 macOS 上，这一数字翻倍至 32 KB。在两个操作系统上，这些字节必须分解为 16 字节的块。</p>
<p>你将在第 16 章中了解有关线程和线程组管理的更多信息。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概括">概括<a href="#概括" class="hash-link" aria-label="概括的直接链接" title="概括的直接链接">​</a></h2>
<p>渲染命令编码器和计算命令编码器的相似之处多于不同之处。自平台推出以来，计算编码器首次允许你在 iOS 上进行通用 GPU 编程。计算编码器允许你利用并行计算而不仅仅是并发。在 GPU 上，由于 CPU 和 GPU 之间的架构差异，你可以进行高性能的数据处理和数学运算。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/zhuanghongji/swift-tutorials-cn/docs/metal-programming-guide/the-metal-compute-pipeline/index.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">最后<!-- -->于 <b><time datetime="2023-11-01T09:22:18.000Z">2023年11月1日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/swift-tutorials-cn/docs/metal-programming-guide/geometry-unleashed-tessellation-in-metal"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">释放几何： Metal 中的镶嵌</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/swift-tutorials-cn/docs/metal-programming-guide/image-processing-in-metal"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Metal 中的图像处理</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#metal-框架概念" class="table-of-contents__link toc-highlight">Metal 框架概念</a></li><li><a href="#gpu-编程简介" class="table-of-contents__link toc-highlight">GPU 编程简介</a></li><li><a href="#并发与并行" class="table-of-contents__link toc-highlight">并发与并行</a></li><li><a href="#使用-gpu-进行一般计算" class="table-of-contents__link toc-highlight">使用 GPU 进行一般计算</a></li><li><a href="#内核函数" class="table-of-contents__link toc-highlight">内核函数</a></li><li><a href="#metal-计算命令编码器" class="table-of-contents__link toc-highlight">Metal 计算命令编码器</a><ul><li><a href="#创建计算管道状态" class="table-of-contents__link toc-highlight">创建计算管道状态</a></li></ul></li><li><a href="#发布工作网格" class="table-of-contents__link toc-highlight">发布工作网格</a><ul><li><a href="#线程组" class="table-of-contents__link toc-highlight">线程组</a></li></ul></li><li><a href="#在内核函数内的网格中寻找方向" class="table-of-contents__link toc-highlight">在内核函数内的网格中寻找方向</a></li><li><a href="#在内核函数中读写资源" class="table-of-contents__link toc-highlight">在内核函数中读写资源</a></li><li><a href="#概括" class="table-of-contents__link toc-highlight">概括</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://developer.apple.com/xcode/swiftui/" target="_blank" rel="noopener noreferrer" class="footer__link-item">SwiftUI Overview</a></li><li class="footer__item"><a href="https://developer.apple.com/documentation/swiftui/" target="_blank" rel="noopener noreferrer" class="footer__link-item">SwiftUI Documentation</a></li><li class="footer__item"><a href="https://developer.apple.com/videos/swiftui-ui-frameworks" target="_blank" rel="noopener noreferrer" class="footer__link-item">SwiftUI &amp; UI Frameworks Videos</a></li><li class="footer__item"><a href="https://docs.swift.org/swift-book/documentation/the-swift-programming-language/" target="_blank" rel="noopener noreferrer" class="footer__link-item">The Swift Programming Language</a></li></ul></div><div class="col footer__col"><div class="footer__title">参考</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.fatbobman.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Fatbob Man</a></li><li class="footer__item"><a href="https://designcode.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Design Code</a></li><li class="footer__item"><a href="https://www.swiftanytime.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Swift Anytime</a></li><li class="footer__item"><a href="https://www.hackingwithswift.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Hacking With Swift</a></li></ul></div><div class="col footer__col"><div class="footer__title">探索</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.youtube.com/@Kavsoft" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kavsoft</a></li><li class="footer__item"><a href="https://www.youtube.com/@ChaoCode" target="_blank" rel="noopener noreferrer" class="footer__link-item">Chao Code</a></li><li class="footer__item"><a href="https://www.youtube.com/@iOSAcademy" target="_blank" rel="noopener noreferrer" class="footer__link-item">iOS Academy</a></li><li class="footer__item"><a href="https://www.youtube.com/@XCA" target="_blank" rel="noopener noreferrer" class="footer__link-item">Xcoding with Alfian</a></li></ul></div><div class="col footer__col"><div class="footer__title">发现</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/swift-tutorials-cn/sponsor-me">Sponsor Me</a></li><li class="footer__item"><a class="footer__link-item" href="/swift-tutorials-cn/sponsor-list">Sponsor List</a></li><li class="footer__item"><a href="https://twitter.com/ajizhhans" target="_blank" rel="noopener noreferrer" class="footer__link-item">Follow Twitter</a></li><li class="footer__item"><a href="https://github.com/zhuanghongji" target="_blank" rel="noopener noreferrer" class="footer__link-item">Follow GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 ZHUANGHONGJI<br><a style="font-size: 12px;color: white;" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International (CC BY 4.0) License</a></div></div></div></footer></div>
</body>
</html>