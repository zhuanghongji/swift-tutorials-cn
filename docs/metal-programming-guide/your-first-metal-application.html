<!doctype html>
<html lang="zh-hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-metal-programming-guide/your-first-metal-application/index">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">你的第一个 Metal 应用 | Swift 悍刀行</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zhuanghongji.github.io/swift-tutorials-cn/docs/metal-programming-guide/your-first-metal-application"><meta data-rh="true" name="docusaurus_locale" content="zh-hans"><meta data-rh="true" name="docsearch:language" content="zh-hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="你的第一个 Metal 应用 | Swift 悍刀行"><meta data-rh="true" name="description" content="为了更好地感受 Metal 的工作原理，我们参观了一个充当 Hello, World! 的老栗子。图形编程：将三角形渲染到屏幕上。本章是一个高级概述，涉及 Metal 生态系统中的各个参与者。本书稍后将对绘制 2D 和 3D 图形进行更深入的探索。本章帮助你打下坚实的基础，在此基础上构建更有用和更复杂的程序。"><meta data-rh="true" property="og:description" content="为了更好地感受 Metal 的工作原理，我们参观了一个充当 Hello, World! 的老栗子。图形编程：将三角形渲染到屏幕上。本章是一个高级概述，涉及 Metal 生态系统中的各个参与者。本书稍后将对绘制 2D 和 3D 图形进行更深入的探索。本章帮助你打下坚实的基础，在此基础上构建更有用和更复杂的程序。"><link data-rh="true" rel="icon" href="/swift-tutorials-cn/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zhuanghongji.github.io/swift-tutorials-cn/docs/metal-programming-guide/your-first-metal-application"><link data-rh="true" rel="alternate" href="https://zhuanghongji.github.io/swift-tutorials-cn/docs/metal-programming-guide/your-first-metal-application" hreflang="zh-hans"><link data-rh="true" rel="alternate" href="https://zhuanghongji.github.io/swift-tutorials-cn/docs/metal-programming-guide/your-first-metal-application" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/swift-tutorials-cn/blog/rss.xml" title="Swift 悍刀行 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/swift-tutorials-cn/blog/atom.xml" title="Swift 悍刀行 Atom Feed"><link rel="stylesheet" href="/swift-tutorials-cn/assets/css/styles.0e4fef4a.css">
<link rel="preload" href="/swift-tutorials-cn/assets/js/runtime~main.6ce8a57d.js" as="script">
<link rel="preload" href="/swift-tutorials-cn/assets/js/main.2bc067b8.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/swift-tutorials-cn/"><div class="navbar__logo"><img src="/swift-tutorials-cn/img/logo.svg" alt="Swift 悍刀行" class="themedImage_ToTc themedImage--light_HNdA"><img src="/swift-tutorials-cn/img/logo.svg" alt="Swift 悍刀行" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Swift 悍刀行</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/swift-tutorials-cn/docs/swift/welcome/about">Swift</a><a class="navbar__item navbar__link" href="/swift-tutorials-cn/docs/swiftui/essentials/about">SwiftUI</a><a class="navbar__item navbar__link" href="/swift-tutorials-cn/docs/swift-charts/essentials/about">SwiftCharts</a><a class="navbar__item navbar__link" href="/swift-tutorials-cn/docs/swiftdata/essentials/about">SwiftData</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Frameworks</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/core-graphics/overview">Core Graphics</a></li><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/metal/overview">Metal</a></li><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/metalkit/overview">MetalKit</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Books</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/swift-tutorials-cn/docs/metal-programming-guide/introdution">Metal Programming Guide</a></li><li><a class="dropdown__link" href="/swift-tutorials-cn/docs/metal-shading-language-specification/preface">Metal Shading Language Specification 3.1</a></li></ul></div><a href="https://github.com/zhuanghongji/swift-tutorials-cn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar-github-link" aria-label="GitHub repository"></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">Metal 编程指南</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/introdution">引言</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/introdution">介绍</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/what-is-metal">Metal 基础</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/what-is-metal">什么是 Metal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/overview-of-rendering-and-raster-graphics">渲染和光栅图形概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/your-first-metal-application">你的第一个 Metal 应用</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/essential-mathematics-for-graphics">渲染与图形</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/essential-mathematics-for-graphics">图形基础数学</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/introduction-to-shaders">着色器简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/metal-resources-and-memory-management">Metal 资源和内存管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/libraries-functions-and-pipeline-states">库、函数和管道状态</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/2d-drawing">2D 绘图</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/introduction-to-3d-drawing">3D 绘图简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/advanced-3d-drawing">高级 3D 绘图</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/interfacing-with-model-io">与模型 I/O 接口</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/texturing-and-sampling">纹理和采样</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/multipass-rendering-techniques">多通道渲染技术</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/geometry-unleashed-tessellation-in-metal">释放几何： Metal 中的镶嵌</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/the-metal-compute-pipeline">数据并行编程</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/the-metal-compute-pipeline">Metal 计算管道</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/image-processing-in-metal">Metal 中的图像处理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/machine-vision">机器视觉</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/metal-performance-shaders-framework">Metal 性能着色器框架</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/neural-network-concepts">神经网络概念</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/swift-tutorials-cn/docs/metal-programming-guide/convolutional-neural-networks">卷积神经网络</a></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/swift-tutorials-cn/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Metal 编程指南</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Metal 基础</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">你的第一个 Metal 应用</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>你的第一个 Metal 应用</h1><div><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>警告</div><div class="admonitionContent_S0QG"><p>该文档目前仅完成 Google 翻译，需进一步校对和润色。</p></div></div></div><div style="padding-left:1rem;padding-right:1rem;padding-top:0.5rem;padding-bottom:0.5rem;border-radius:0.5rem;background-color:#333333"><p>即使是最大的雪崩也是由小事情引发的。</p>— 弗诺·文奇</div><br><p>为了更好地感受 Metal 的工作原理，我们参观了一个充当 Hello, World! 的老栗子。图形编程：将三角形渲染到屏幕上。本章是一个高级概述，涉及 Metal 生态系统中的各个参与者。本书稍后将对绘制 2D 和 3D 图形进行更深入的探索。本章帮助你打下坚实的基础，在此基础上构建更有用和更复杂的程序。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="在-xcode-中创建-metal-应用程序">在 Xcode 中创建 Metal 应用程序<a href="#在-xcode-中创建-metal-应用程序" class="hash-link" aria-label="在 Xcode 中创建 Metal 应用程序的直接链接" title="在 Xcode 中创建 Metal 应用程序的直接链接">​</a></h2><p>本章首先在不使用内置 Apple 模板的情况下设置 Metal。你可能想知道为什么你想要重新发明轮子而不是仅仅使用苹果提供给你的东西。</p><p>首先，亲自设置各个部件可以让你对 Metal 中的每个移动部件有良好的感觉。你负责以你不习惯的方式管理内存，因此最好熟悉你将来要配置的所有对象。其次，Apple 的模板和示例代码往往包含一些你的项目中不一定需要的脚手架。当你刚开始时，可能很难区分什么是绝对必要的，什么是多余的。重新开始可以让你知道什么是最基本的必要对象。就这样，我们开始吧。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="在-xcode-中创建项目">在 Xcode 中创建项目<a href="#在-xcode-中创建项目" class="hash-link" aria-label="在 Xcode 中创建项目的直接链接" title="在 Xcode 中创建项目的直接链接">​</a></h3><p>Xcode 是 Apple 的集成设计环境 (IDE)，程序员可以在其中为 Apple 设备开发应用程序。它是一款免费应用程序，可以从 Mac App Store 下载。是的，这意味着 Xcode 是仅适用于 Mac 的 IDE。要开发 iOS 应用程序，你必须拥有（或有权访问）运行 Metal 的 Mac 和 iOS 设备 Xcode 是一个大型且复杂的应用程序。深入探讨 Xcode 超出了本书的范围。如果你想要或需要更加熟悉它，可以使用许多资源。如果你是一位经验丰富的 iOS 开发人员，则可以跳至下一部分。</p><p>应用程序启动后，你将获得几个选项来创建新项目或打开一个项目。选择 <em>创建新项目</em>。这将打开另一个窗口，你可以在其中选择模板 Metal 模板巧妙地隐藏在 Game 模板中。由于我们不打算从模板生成 Metal 项目，因此选择 <em>单视图应用程序</em>。对于你未来的任何项目来说，这通常是一个不错的选择作为入门模板。</p><p>选择单一视图应用程序后，系统会要求你命名应用程序。确保你有公司标识符。如果你不是 Apple 开发者并且只是进行探索，只需输入你的名字即可。你不需要选择核心数据或任何其它选项。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="xcode-模拟器和-metal">Xcode 模拟器和 Metal<a href="#xcode-模拟器和-metal" class="hash-link" aria-label="Xcode 模拟器和 Metal的直接链接" title="Xcode 模拟器和 Metal的直接链接">​</a></h3><p>Xcode 附带一个模拟器，允许你测试应用程序，而无需将它们构建到设备上。如果你查看左上角，你会看到一个“播放”按钮。它会启动模拟器并允许你查看代码的工作原理。</p><p>目前，模拟器无法与 Metal 配合使用。因此，要检查你的应用程序，你需要在设备上构建它。为此，你需要拥有 Apple 开发者帐户（在 <a href="https://developer.apple.com" target="_blank" rel="noopener noreferrer">https://developer.apple.com</a> 注册）。除非你打算在 App Store 上销售应用程序，否则请注册一个免费帐户。</p><p>第一次尝试在手机上构建时，系统会提示你在手机上授权你的开发者帐户。此外，由于 Xcode 无法在模拟器中构建 Metal 项目，因此如果你在“运行”按钮旁边的方案编辑器上设置了模拟器，你将收到一些毫无意义的错误。你经常会看到与此问题相关的一个错误：“CAMetalLayer 不存在。”如果你在未接触过的代码中看到奇怪的错误，请检查以确保构建目标不是模拟器。</p><p>你的新项目中有许多文件。你现在可以忽略其中的大部分。你将主要在 ViewController.swift 中工作。在视图控制器的顶部，你需要导入 Metal。你应该直接在 UIKit 的导入下执行此操作：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token class-name">Metal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token class-name">UIKit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Xcode 要求你导入要在项目中引用的每个框架。这不是你要导入的唯一框架，但目前就足够了。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="创建-mtldevice">创建 MTLDevice<a href="#创建-mtldevice" class="hash-link" aria-label="创建 MTLDevice的直接链接" title="创建 MTLDevice的直接链接">​</a></h2><p>Metal 的基础是 GPU。要与 GPU 交互，你需要在代码中为其创建软件接口。这个接口就是 MTLDevice 协议。符合 MTLDevice 协议的对象代表 Mac 或 iOS 设备中的 GPUApple 不希望你尝试对 MTLDevice 进行子类化，因为它非常接近 Metal ，覆盖此协议上的内置函数可能会导致你的应用程序出现严重问题。在视图控制器类的顶部，你需要创建 MTLDevice 的实例：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token class-name">MTLDevice</span><span class="token operator">!</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token nil constant" style="color:rgb(189, 147, 249)">nil</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当你在类顶部创建属性时，无法初始化该设备 MTLDevice 有一种（也是唯一一种）安全的初始化方法。该方法应该在函数 viewDidLoad() 中调用。在视图加载时但用户可以与应用程序交互之前需要进行的任何设置都应该放在 viewDidLoad() 中。</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">device </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">MTLCreateSystemDefaultDevice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这就是设置与 GPU 的软件接口所需要做的全部工作。应用程序的其余部分将引用该设备对象。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="创建-cametallayer">创建 CAMetalLayer<a href="#创建-cametallayer" class="hash-link" aria-label="创建 CAMetalLayer的直接链接" title="创建 CAMetalLayer的直接链接">​</a></h2><p>Metal 可以将图像渲染到屏幕上，但它不允许你与它们交互。在 iOS 中，屏幕和用户之间的交互由核心动画层控制。</p><p>Metal 和之前的 OpenGL 都有特殊的核心动画层，你需要创建这些层并将其附加到视图。首先，你需要导入另一个框架：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token class-name">QuartzCore</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接下来，你需要创建特殊的核心动画支持的 Metal 层的实例：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> metalLayer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">CAMetalLayers</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>再次，正如你在初始化 <code>MTLDevice</code> 时所做的那样，你将在 <code>viewDidLoad()</code> 中初始化你的 <code>CAMetalLayer：</code></p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">metalLayer </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">CAMetalLayer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metalLayer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">device </span><span class="token operator">=</span><span class="token plain"> device</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metalLayer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">pixelFormat </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">bgra8Unorm</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metalLayer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">framebufferOnly </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metalLayer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">frame </span><span class="token operator">=</span><span class="token plain"> view</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">frame</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">view</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">layer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">addSublayer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">metalLayer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>首先，你要初始化 <code>CAMetalLayer</code>。然后，你告诉它要连接的层是你之前创建的 <code>MTLDevice</code>。你正在该图层上设置一些其它属性。这些默认值很好，如果你想自己进一步研究它们，请继续。最后，视图需要将该图层与其自身关联起来，因此在设置其所有属性后，你需要将其添加为子图层。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="创建顶点缓冲区">创建顶点缓冲区<a href="#创建顶点缓冲区" class="hash-link" aria-label="创建顶点缓冲区的直接链接" title="创建顶点缓冲区的直接链接">​</a></h2><p>Metal 中的所有图像都是由原始形状组成的 Metal 中最常见的原始形状是三角形。所有形状都可以由三角形组成。你不能只将一堆三角形输入到软件程序中。你需要某种方法在代码中表示这些三角形。这是通过使用 <em>vertices</em> 来完成的。顶点是图形编程中描述属性的数据结构。这些可以是颜色或纹理位置数据。在这个简单的示例中，顶点描述了三角形尖端处的空间二维位置。</p><p>Metal 使用 <em>标准化坐标系</em>。坐标不是使用英寸或克罗波格等离散的测量单位，而是以与整体的比例来表示。如果你看一下 iPhone，你会发现它的高度大于宽度。尽管它的高度大于宽度，但它仍被视为一单位宽乘一单位高。这些单位的比例在不同形状的屏幕上代表不同的数量 Metal 的标准化坐标系是两个单位乘两个单位乘一个单位。这意味着左上角的坐标是 <code>(1, 1, 1)</code>。右下角的坐标是 <code>(-1, -1, 0)</code>。坐标系的中心由 <code>(0, 0, 0.5)</code> 表示，如图 3.1 所示。</p><div style="display:flex;flex-direction:column;width:100%;justify-content:center;align-items:center"><div style="width:320px;padding:1rem;background-color:white"><div style="background-size:cover;background-repeat:no-repeat;position:relative;background-image:url(&quot;data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAALAAoDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAQMECP/EAB4QAAICAgMBAQAAAAAAAAAAAAECAxEAISIxQRIT/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/EABQRAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhEDEQA/ANMFo0kgX5QLZMlqOjdb83k8saCR+K9nzAJW5AhTZINqDYvFfox2Ts4H/9k=&quot;);width:100%"><svg style="width:100%;height:auto;max-width:100%;margin-bottom:-4px" width="274" height="318"></svg><noscript><img style="width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0" src="/swift-tutorials-cn/assets/ideal-img/3_1.af33310.274.jpg" srcset="/swift-tutorials-cn/assets/ideal-img/3_1.af33310.274.jpg 274w" width="274" height="318"></noscript></div></div><p style="margin-top:0.5rem;font-size:1.0rem"><em>图 3.1 Metal 的标准化坐标系，映射了一个三角形</em></p></div><p>无论屏幕的长宽比是多少，Metal 都会使用标准化坐标系统。无论你看的是高度是宽度两倍的 iPhone，还是完美方形的 Apple Watch，这一点都适用。</p><p>你需要创建一个数组来保存绘制三角形所需的所有位置数据。你将创建的三角形大约是屏幕大小的一半，因此你的三角形数据将如下所示：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> vertexData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token class-name">Float</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token number">0.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token number">0.5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token number">0.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token number">0.5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>GPU 无法访问当前形式的数据。数据必须编码到缓冲区中，因此你需要创建一个 <em>vertex buffer</em> 来保存它：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> vertexBuffer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">MTLBuffer</span><span class="token operator">!</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token nil constant" style="color:rgb(189, 147, 249)">nil</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>正如对 <code>MTLDevice</code> 实例所做的那样，你必须在 <code>viewDidLoad()</code> 方法中设置顶点缓冲区的数据：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> dataSize </span><span class="token operator">=</span><span class="token plain"> vertexData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">count </span><span class="token operator">*</span><span class="token plain"> </span><span class="token class-name">MemoryLayout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">size</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ofValue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> vertexData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vertexBuffer </span><span class="token operator">=</span><span class="token plain"> device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">makeBuffer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">bytes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> vertexData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                                 length</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> dataSize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                                 options</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">storageModePrivate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>要创建足够大的缓冲区来容纳数据，你需要确定顶点数组的大小。接下来，根据数组大小，指定需要多少字节并将缓冲区指向顶点数据。该顶点缓冲区已准备好可供 GPU 处理的数据。这项工作是由着色器完成的，我们接下来将介绍它。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="着色器初探">着色器初探<a href="#着色器初探" class="hash-link" aria-label="着色器初探的直接链接" title="着色器初探的直接链接">​</a></h2><p>我们花了很多时间讨论为 GPU 准备数据。你编写的指示 GPU 如何处理数据的实际代码以 <em>shaders</em> 的形式出现。</p><p>图形程序中的着色器函数有两个组成部分：<em>vertex</em> 和 <em>fragment</em>。顶点着色器接收缓冲区数据并返回有关每个顶点的信息，例如位置和颜色。片段着色器接收有关场景的信息并确定场景中每个像素的颜色。</p><p>两种着色器类型均采用基于 C++14 的 <em>Metal Shading Language</em> (MSL) 编写。各种着色语言中着色器的原理相当一致，因此如果你熟悉其它语言，例如 OpenGL 着色语言，那么学习 MSL 应该很容易。</p><p>你需要创建一个新文件来保存着色器。你可以将多个着色器放入一个文件中，也可以将它们拆分为不同的文件。这是你的选择。只要文件具有 .metal 扩展名并且包含在目标的编译源阶段，它就会被编译到默认库中，我们稍后会讨论该库。</p><p>创建一个新文件。从模板选项中选择 <em>Metal</em>，并将新文件命名为 <em>Shaders.metal</em>。确保该文件保存到你的项目目录中。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建顶点着色器">创建顶点着色器<a href="#创建顶点着色器" class="hash-link" aria-label="创建顶点着色器的直接链接" title="创建顶点着色器的直接链接">​</a></h3><p>所有顶点着色器必须以关键字 <em>vertex</em> 开头。它们还必须至少以 <code>float4</code> 对象的形式返回顶点的位置数据。将以下代码添加到着色器文件的底部：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">vertex float4 </span><span class="token function" style="color:rgb(80, 250, 123)">basic_vertex</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> device packed_float3</span><span class="token operator">*</span><span class="token plain"> vertex_array </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">buffer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                           </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">int</span><span class="token plain"> vid </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"> vertex_id </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">float4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">vertex_array</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">vid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">1.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>该顶点着色器接收两个参数。第一个参数是每个顶点的位置 <code>[[ buffer(0) ]]</code> 代码指定顶点着色器从发送到着色器的第一个顶点缓冲区中提取数据。因为你只创建了一个顶点缓冲区，所以很容易找出哪个是第一个。第二个参数是顶点数组中顶点的索引。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建片段着色器">创建片段着色器<a href="#创建片段着色器" class="hash-link" aria-label="创建片段着色器的直接链接" title="创建片段着色器的直接链接">​</a></h3><p>片段着色器负责计算屏幕上每个像素的颜色，如图 3.2 所示。它根据从顶点接收的颜色数据计算颜色。如果一个顶点为红色，另一个顶点为绿色，则这些顶点之间的每个像素都将按渐变着色。红色和绿色的数量是根据每个顶点的远近来计算的。</p><div style="display:flex;flex-direction:column;width:100%;justify-content:center;align-items:center"><div style="background-size:cover;background-repeat:no-repeat;position:relative;background-image:url(&quot;data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAHAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAUI/8QAJBAAAQMDAQkAAAAAAAAAAAAAAgABAwQFERITMTJBUVKBktH/xAAUAQEAAAAAAAAAAAAAAAAAAAAB/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAR/9oADAMBAAIRAxEAPwDQcElYF1eR5aWS2mAi0ekmOPDcW7D55+Oirben7g9X+IiV2Ay//9k=&quot;);width:420px"><svg style="width:100%;height:auto;max-width:100%;margin-bottom:-4px" width="358" height="248"></svg><noscript><img style="width:100%;height:auto;max-width:100%;margin-bottom:-4px;position:absolute;top:0;left:0" src="/swift-tutorials-cn/assets/ideal-img/3_2.d874702.358.jpg" srcset="/swift-tutorials-cn/assets/ideal-img/3_2.d874702.358.jpg 358w" width="358" height="248"></noscript></div><p style="margin-top:0.5rem;font-size:1.0rem"><em>图 3.2 顶点和片段着色器负责的工作</em></p></div><p>每个片段着色器程序都以关键字 <em>fragment</em> 开头。将此代码添加到着色器文件的底部：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">fragment half4 </span><span class="token function" style="color:rgb(80, 250, 123)">basic_fragment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">half4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>至少，每个片段着色器必须返回它正在着色的像素的颜色。这由 half4 类型表示。该着色器只是将颜色设置为白色。</p><p>这只是着色器功能的一小部分。尽管我们在本书中提供了有关它们的更多信息，但对着色器的全面讨论可以而且确实会填满几本书，但超出了本书的范围。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="库函数和管道状态">库、函数和管道状态<a href="#库函数和管道状态" class="hash-link" aria-label="库、函数和管道状态的直接链接" title="库、函数和管道状态的直接链接">​</a></h2><p>着色器是 <code>MTLFunction</code> 对象的示例 <code>MTLFunction</code> 对象以 MSL 编写并在 GPU 上执行 <code>MTLFunction</code> 共有三种不同类型：顶点、片段和内核。我们已经看到了顶点函数和片段函数。</p><p><code>MTLFunction</code> 收集在 <code>MTLLibrary</code> 对象中 <code>MTLLibrary</code> 中可以有一个或多个 <code>MTLFunction</code>。这些函数可以从应用程序构建过程中创建的已编译二进制库或从运行时编译的文本字符串创建。</p><p>你需要创建一个库来保存着色器程序：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">let defaultLibrary </span><span class="token operator">=</span><span class="token plain"> device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">newDefaultLibrary</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">let fragmentProgram </span><span class="token operator">=</span><span class="token plain"> defaultLibrary</span><span class="token operator">!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">makeFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;basic_fragment&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">let vertexProgram </span><span class="token operator">=</span><span class="token plain"> defaultLibrary</span><span class="token operator">!</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">makeFunction</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;basic_vertex&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在这段代码中，你将创建一个新的默认 <code>MTLLibrary</code> 来保存着色器程序。然后，你将创建两个 <code>MTLFunction</code> 来保存片段和顶点着色器。这些函数名称应该看起来很熟悉，因为它们是你在上一节中编写的着色器。由于这些函数位于扩展名为 .metal 的文件中，因此库将知道在哪里查找它们。</p><p>现在你已经有了一个包含着色器的默认库，你可以将它们添加到渲染管道中。渲染管道包含将三角形渲染到</p><p>屏幕。首先，你需要设置一个对象来保存渲染管道需要引用的所有状态。将其添加到所有其它属性下方：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">var pipelineState</span><span class="token operator">:</span><span class="token plain"> MTLRenderPipelineState</span><span class="token operator">!</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> nil</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接下来，将以下代码添加到 <code>viewDidLoad()</code> 的末尾：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> pipelineStateDescriptor </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">MTLRenderPipelineDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pipelineStateDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">vertexFunction </span><span class="token operator">=</span><span class="token plain"> vertexProgram</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pipelineStateDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fragmentFunction </span><span class="token operator">=</span><span class="token plain"> fragmentProgram</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pipelineStateDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">colorAttachments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">pixelFormat </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">bgra8Unorm</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">do</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> pipelineState </span><span class="token operator">=</span><span class="token plain"> device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">makeRenderPipelineState</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">descriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> pipelineStateDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> error </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">print</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">&quot;Failed to create pipeline state, error </span><span class="token string-literal interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">\(</span><span class="token string-literal interpolation">error</span><span class="token string-literal interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token string-literal string" style="color:rgb(255, 121, 198)">&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用此代码，你首先初始化渲染管道描述符。接下来，你将添加在创建库时创建的顶点和片段程序。由于管道状态容易出错，因此你需要进行错误处理以确保初始化有效的管道状态。这对于 Metal 来说非常重要 Metal 可用的优化之一是预先验证渲染管道状态。如果你的管道状态设置不正确，你希望此操作立即失败，而不是在开始向 GPU 发送数据之后失败。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="渲染通道简介">渲染通道简介<a href="#渲染通道简介" class="hash-link" aria-label="渲染通道简介的直接链接" title="渲染通道简介的直接链接">​</a></h2><p>现在渲染管道已经设置完毕，是时候考虑设置渲染通道了。渲染通道是组成场景的机制。可以进行多次传递来添加其它对象和细节。例如，你可以渲染不同的对象或在单独的通道中添加照明和突出显示效果。</p><p>你需要创建的第一件事是渲染通道描述符。将此代码放在一个单独的方法中是有意义的，该方法可以在每次需要渲染新帧时运行。在视图类中创建一个名为 <code>render()</code> 的新方法：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">render</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> renderPassDescriptor </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">MTLRenderPassDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">guard</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> drawable </span><span class="token operator">=</span><span class="token plain"> metalLayer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">nextDrawable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    renderPassDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">colorAttachments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">texture </span><span class="token operator">=</span><span class="token plain"> drawable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">texture</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    renderPassDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">colorAttachments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">loadAction </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">clear</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    renderPassDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">colorAttachments</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">clearColor </span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token class-name">MTLClearColor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">red</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">221.0</span><span class="token operator">/</span><span class="token number">255.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> green</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">160.0</span><span class="token operator">/</span><span class="token number">255.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> blue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">221.0</span><span class="token operator">/</span><span class="token number">255.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> alpha</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>render() 方法设置渲染通道描述符。该描述符包含描述颜色、深度和模板数据的附件集合。在我们的简单程序中，我们只设置颜色数据。我们的描述符针对的是数组中的第一个颜色附件。它正在设置渲染通道以清除之前存在的任何颜色，并用漂亮的梅子色填充屏幕。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="命令队列和命令编码器">命令队列和命令编码器<a href="#命令队列和命令编码器" class="hash-link" aria-label="命令队列和命令编码器的直接链接" title="命令队列和命令编码器的直接链接">​</a></h3><p>现在你已经设置了渲染通道描述符，你需要一种将工作提交到 GPU 执行的方法。这是通过命令队列完成的。命令队列是负责与 GPU 调度时间来完成工作的对象。</p><p>将此属性与其它属性一起添加到类的顶部：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> commandQueue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">MTLCommandQueue</span><span class="token operator">!</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token nil constant" style="color:rgb(189, 147, 249)">nil</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>再次在 <code>viewDidLoad()</code> 中初始化命令队列：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">commandQueue </span><span class="token operator">=</span><span class="token plain"> device</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">makeCommandQueue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>命令队列是一个创建成本昂贵的对象，因此你只想创建一个并重用它。命令队列不直接接受渲染通道。相反，它采用命令缓冲区对象。命令缓冲区对象的创建成本很低。当你使用完它们后，它们就会被使用和处理掉。将此行添加到 <code>render()</code> 方法的底部：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> commandBuffer </span><span class="token operator">=</span><span class="token plain"> commandQueue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">makeCommandBuffer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="发出绘图调用">发出绘图调用<a href="#发出绘图调用" class="hash-link" aria-label="发出绘图调用的直接链接" title="发出绘图调用的直接链接">​</a></h3><p>命令缓冲区需要对渲染命令进行编码，以便知道要发送到 GPU 的工作。这是你在整个项目中所做的所有设置的集合点。它获取你设置的所有管道状态和你处理过的所有顶点数据并对渲染通道进行编码。通过将以下代码添加到方法末尾来完成 render() 函数：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> renderEncoder </span><span class="token operator">=</span><span class="token plain"> commandBuffer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">makeRenderCommandEncoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">descriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> renderPassDescriptor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">renderEncoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">setRenderPipelineState</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">pipelineState</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">renderEncoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">setVertexBuffer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">vertexBuffer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> offset</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> at</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">renderEncoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">drawPrimitives</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">triangle</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> vertexStart</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> vertexCount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">renderEncoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">endEncoding</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">commandBuffer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">present</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">drawable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">commandBuffer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">commit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>renderEncoder</code> 对象使用管道状态和顶点缓冲区进行编码。这也是你的绘图调用所在的位置。在 <code>drawPrimitives()</code> 中，你告诉 GPU 它需要绘制什么类型的图元，以便它知道有多少个顶点构成一个形状。第 8 章“二维绘图”对此进行了更详细的解释。</p><p><code>render()</code> 方法现已完成。你需要从某个地方调用它，因此设置一个游戏循环：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function-definition function" style="color:rgb(80, 250, 123)">gameloop</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    autoreleasepool </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">render</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>你的所有数据均已准备好并准备发送到 GPU。此过程的最后一步是将三角形实际呈现在屏幕上。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="在屏幕上呈现-metal-内容">在屏幕上呈现 Metal 内容<a href="#在屏幕上呈现-metal-内容" class="hash-link" aria-label="在屏幕上呈现 Metal 内容的直接链接" title="在屏幕上呈现 Metal 内容的直接链接">​</a></h3><p>每次渲染过程创建一个帧时，你都需要视图控制器类知道它需要刷新屏幕。这是使用 <code>CADisplayLink</code> 完成的 <code>CADisplayLink</code> 是一个特殊的计时器，用于协调绘制调用与屏幕的刷新率。在视图控制器类的顶部创建计时器属性：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> timer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">CADisplayLink</span><span class="token operator">!</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token nil constant" style="color:rgb(189, 147, 249)">nil</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 <code>viewDidLoad()</code> 的底部，创建计时器。每次屏幕刷新时，计时器都会调用游戏循环，这会向 GPU 发出它有工作要做的信号：</p><div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">timer </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">CADisplayLink</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">target</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> selector</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token other-directive property">#selector</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token class-name">ViewController</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">gameloop</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">timer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">RunLoop</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">main</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> forMode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token class-name">RunLoopMode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">defaultRunLoopMode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>每次屏幕刷新时，都会发生一些事情。屏幕被清除并替换为紫色背景。然后绘制调用开始，告诉 GPU 获取准备好的顶点数据并构建三角形。然后将其发送到片段着色器，该片段着色器将三角形内的每个像素着色为白色。渲染通道获取此数据并将其绘制到屏幕上。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="metalkit-功能和-mtkview-简介">MetalKit 功能和 MTKView 简介<a href="#metalkit-功能和-mtkview-简介" class="hash-link" aria-label="MetalKit 功能和 MTKView 简介的直接链接" title="MetalKit 功能和 MTKView 简介的直接链接">​</a></h2><p>苹果以其无限的智慧意识到，每次使用 Metal 时都进行如此大量的设置并不是真正的最佳选择。对于所有应用程序来说，设置 Metal 所采取的一些步骤基本上都是相同的。因为不断地编写样板代码是没有意义的，所以 iOS 9 中引入了一个新的框架。</p><p>MetalKit 旨在减少三个关键领域的工作量：</p><ul><li>纹理加载</li><li>模型处理</li><li>视图管理</li></ul><p>本书稍后将更深入地介绍纹理加载和模型处理。在这里，我们重点关注视图管理。你必须进行大量设置才能创建 CAMetalLayer 并将其附加到视图。你还必须设置渲染循环并将其连接到 CADisplayLink。这些任务必须为你创建的每个 Metal 应用程序完成，并且为每个应用程序重写该样板是没有意义的。因此，样板代码由 MTKView 和 MTKViewDelegate 负责。</p><p><code>MTKView</code> 无需设置 <code>CAMetalLayer</code> 或 <code>CADisplayLinkMTKView</code> 具有三种不同的模式，可用于在屏幕上绘制。默认模式根据内部计时器进行绘制，类似于你在“Hello，Triangle！”中设置的模式。应用。第二种模式使用通知，仅当被告知某些内容已更改并且需要重绘时，视图才会重绘。最后一种模式使用 <code>MTKView</code> 方法，<code>draw()</code>。仅当调用 <code>draw()</code> 时视图才会绘制。第 8 章将更深入地探讨这种模式。</p><p>你可以选择子类化 MTKView 或使视图符合 MTKViewDelegateMTKViewDelegate 还有一个 <code>draw()</code> 方法，可以代替 <code>MTKView</code> 的 <code>draw</code> 方法来实现。做你喜欢做的事；这个选择由你。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概括">概括<a href="#概括" class="hash-link" aria-label="概括的直接链接" title="概括的直接链接">​</a></h2><p>准备供 GPU 处理的数据和程序需要许多步骤。你需要实现一个特殊的核心动画层，以允许用户与 Metal 支持的视图进行交互。屏幕上的所有对象都是由图元组成的。这些图元由顶点数据数组表示。使用顶点缓冲区准备顶点数据并将其发送到 GPU。在 GPU 上运行的程序称为着色器，并用 MSL 编写。工作安排由</p><p>命令缓冲区形式的命令队列。这些缓冲区用命令和状态信息进行编码。它们启动绘制调用，通知 GPU 执行预定的工作。作品完成后，呈现在屏幕上。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/zhuanghongji/swift-tutorials-cn/docs/metal-programming-guide/your-first-metal-application/index.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">最后<!-- -->于 <b><time datetime="2023-09-21T05:30:50.000Z">2023年9月21日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/swift-tutorials-cn/docs/metal-programming-guide/overview-of-rendering-and-raster-graphics"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">渲染和光栅图形概述</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/swift-tutorials-cn/docs/metal-programming-guide/essential-mathematics-for-graphics"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">图形基础数学</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#在-xcode-中创建-metal-应用程序" class="table-of-contents__link toc-highlight">在 Xcode 中创建 Metal 应用程序</a><ul><li><a href="#在-xcode-中创建项目" class="table-of-contents__link toc-highlight">在 Xcode 中创建项目</a></li><li><a href="#xcode-模拟器和-metal" class="table-of-contents__link toc-highlight">Xcode 模拟器和 Metal</a></li></ul></li><li><a href="#创建-mtldevice" class="table-of-contents__link toc-highlight">创建 MTLDevice</a></li><li><a href="#创建-cametallayer" class="table-of-contents__link toc-highlight">创建 CAMetalLayer</a></li><li><a href="#创建顶点缓冲区" class="table-of-contents__link toc-highlight">创建顶点缓冲区</a></li><li><a href="#着色器初探" class="table-of-contents__link toc-highlight">着色器初探</a><ul><li><a href="#创建顶点着色器" class="table-of-contents__link toc-highlight">创建顶点着色器</a></li><li><a href="#创建片段着色器" class="table-of-contents__link toc-highlight">创建片段着色器</a></li></ul></li><li><a href="#库函数和管道状态" class="table-of-contents__link toc-highlight">库、函数和管道状态</a></li><li><a href="#渲染通道简介" class="table-of-contents__link toc-highlight">渲染通道简介</a><ul><li><a href="#命令队列和命令编码器" class="table-of-contents__link toc-highlight">命令队列和命令编码器</a></li><li><a href="#发出绘图调用" class="table-of-contents__link toc-highlight">发出绘图调用</a></li><li><a href="#在屏幕上呈现-metal-内容" class="table-of-contents__link toc-highlight">在屏幕上呈现 Metal 内容</a></li></ul></li><li><a href="#metalkit-功能和-mtkview-简介" class="table-of-contents__link toc-highlight">MetalKit 功能和 MTKView 简介</a></li><li><a href="#概括" class="table-of-contents__link toc-highlight">概括</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://developer.apple.com/xcode/swiftui/" target="_blank" rel="noopener noreferrer" class="footer__link-item">SwiftUI Overview</a></li><li class="footer__item"><a href="https://developer.apple.com/documentation/swiftui/" target="_blank" rel="noopener noreferrer" class="footer__link-item">SwiftUI Documentation</a></li><li class="footer__item"><a href="https://developer.apple.com/videos/swiftui-ui-frameworks" target="_blank" rel="noopener noreferrer" class="footer__link-item">SwiftUI &amp; UI Frameworks Videos</a></li><li class="footer__item"><a href="https://docs.swift.org/swift-book/documentation/the-swift-programming-language/" target="_blank" rel="noopener noreferrer" class="footer__link-item">The Swift Programming Language</a></li></ul></div><div class="col footer__col"><div class="footer__title">参考</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.fatbobman.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Fatbob Man</a></li><li class="footer__item"><a href="https://designcode.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Design Code</a></li><li class="footer__item"><a href="https://www.swiftanytime.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Swift Anytime</a></li><li class="footer__item"><a href="https://www.hackingwithswift.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Hacking With Swift</a></li></ul></div><div class="col footer__col"><div class="footer__title">探索</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.youtube.com/@Kavsoft" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kavsoft</a></li><li class="footer__item"><a href="https://www.youtube.com/@ChaoCode" target="_blank" rel="noopener noreferrer" class="footer__link-item">Chao Code</a></li><li class="footer__item"><a href="https://www.youtube.com/@iOSAcademy" target="_blank" rel="noopener noreferrer" class="footer__link-item">iOS Academy</a></li><li class="footer__item"><a href="https://www.youtube.com/@XCA" target="_blank" rel="noopener noreferrer" class="footer__link-item">Xcoding with Alfian</a></li></ul></div><div class="col footer__col"><div class="footer__title">发现</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/swift-tutorials-cn/sponsor-me">Sponsor Me</a></li><li class="footer__item"><a class="footer__link-item" href="/swift-tutorials-cn/sponsor-list">Sponsor List</a></li><li class="footer__item"><a href="https://twitter.com/ajizhhans" target="_blank" rel="noopener noreferrer" class="footer__link-item">Follow Twitter</a></li><li class="footer__item"><a href="https://github.com/zhuanghongji" target="_blank" rel="noopener noreferrer" class="footer__link-item">Follow GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 ZHUANGHONGJI<br><a style="font-size: 12px;color: white;" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International (CC BY 4.0) License</a></div></div></div></footer></div>
<script src="/swift-tutorials-cn/assets/js/runtime~main.6ce8a57d.js"></script>
<script src="/swift-tutorials-cn/assets/js/main.2bc067b8.js"></script>
</body>
</html>